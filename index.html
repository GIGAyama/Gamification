<!DOCTYPE html>
<html>
<head>
<base target="_top">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
/* åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
body { font-family: 'Noto Sans JP', sans-serif; }
h1, h2, h3, .font-mplus { font-family: 'Mochiy+Pop+One', sans-serif; }

/* ã‚¢ãƒ—ãƒªå…¨ä½“ã®é…è‰²ãƒ†ãƒ¼ãƒ */
.bg-fantasy { background-color: #f3e9d2; }
.text-fantasy-deep { color: #4a403a; }
.text-fantasy-brown { color: #8c6b5d; }
.bg-fantasy-card { background-color: #fffaf0; }
.border-fantasy-brown { border-color: #c7a99a; }

/* ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
.btn-primary, .btn-secondary, .btn-gacha, .btn-gacha10, .btn-claim {
color: white;
font-family: 'Mochiy Pop One', sans-serif;
padding: 10px 20px;
border-radius: 8px;
transition: all 0.2s ease;
cursor: pointer;
border-bottom-width: 4px;
}
.btn-primary { background-color: #5a9c5a; border-color: #3e6b3e; }
.btn-primary:hover:not(:disabled) { background-color: #4a8c4a; transform: translateY(2px); border-bottom-width: 2px; }
.btn-secondary { background-color: #a98a78; border-color: #8c6b5d; }
.btn-secondary:hover:not(:disabled) { background-color: #9a7c6c; transform: translateY(2px); border-bottom-width: 2px; }
.btn-gacha { background-color: #8b5cf6; border-color: #6d28d9; }
.btn-gacha:hover:not(:disabled) { background-color: #7c3aed; transform: translateY(2px); border-bottom-width: 2px; }
.btn-gacha10 { background-color: #f59e0b; border-color: #b45309; }
.btn-gacha10:hover:not(:disabled) { background-color: #d97706; transform: translateY(2px); border-bottom-width: 2px; }
.btn-claim { background-color: #2563eb; border-color: #1d4ed8; }
.btn-claim:hover:not(:disabled) { background-color: #1e40af; transform: translateY(2px); border-bottom-width: 2px; }
button:disabled { background-color: #9ca3af; border-color: #6b7280; cursor: not-allowed; }
.btn-mission { padding: 4px 10px; font-size: 12px; border-radius: 6px; }

/* ãã®ä»–UIè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.exp-bar-bg { background-color: #e0d8c7; }
.exp-bar-fill { background: linear-gradient(90deg, #ffd700, #ffec80); }
.nav-item.active { background-color: #d4bfaa; color: #fff; }
.view { display: none; }
.view.active { display: block; }
.tooltip { position: relative; display: inline-block; }
.tooltip .tooltip-text { visibility: hidden; width: 200px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; }
.tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
.gacha-results-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; max-height: 50vh; overflow-y: auto; padding: 8px; background-color: #f9fafb; border-radius: 8px; }
.gacha-item-card { position: relative; border: 1px solid #e5e7eb; border-radius: 8px; background-color: white; padding: 4px; aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.gacha-item-card.is-sr { background: linear-gradient(45deg, #fde68a, #f59e0b); box-shadow: 0 0 10px #f59e0b; }
.gacha-item-card.is-r { background: linear-gradient(45deg, #93c5fd, #3b82f6); box-shadow: 0 0 10px #3b82f6; }
.gacha-item-card img { max-width: 90%; max-height: 90%; object-fit: contain; }
.duplicate-overlay { position: absolute; inset: 0; background-color: rgba(0, 0, 0, 0.6); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; text-align: center; font-size: 0.875rem; font-weight: 600; }

/* ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¼”å‡ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
#level-up-modal { z-index: 100; }
.celebrate-title { animation: zoom-in-out 1s ease-in-out forwards; }
.celebrate-level { animation: scale-up 1s ease-in-out 0.5s forwards; transform: scale(0); }
@keyframes zoom-in-out {
 0% { transform: scale(0); opacity: 0; }
 50% { transform: scale(1.2); opacity: 1; }
 100% { transform: scale(1); opacity: 1; }
}
@keyframes scale-up {
 0% { transform: scale(0); opacity: 0; }
 100% { transform: scale(1); opacity: 1; }
}
/* ç´™å¹é›ªã®ã‚¹ã‚¿ã‚¤ãƒ« */
.confetti-piece { position: absolute; width: 8px; height: 16px; background: #f00; top: -20px; opacity: 0; }
@keyframes confetti-fall {
   0% { transform: translateY(0) rotate(0deg); opacity: 1; }
   100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* ã‚¬ãƒãƒ£èª­ã¿è¾¼ã¿ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#gacha-loading-modal { z-index: 90; }
.gacha-capsule {
 width: 100px;
 height: 100px;
 background: linear-gradient(180deg, #fde047 50%, #f1f5f9 50%);
 border-radius: 50%;
 border: 4px solid #4b5563;
 position: relative;
 animation: shake-spin 1.5s cubic-bezier(.36,.07,.19,.97) infinite;
}
.gacha-capsule::before {
 content: '';
 position: absolute;
 top: 50%;
 left: 0;
 right: 0;
 height: 8px;
 background: #4b5563;
 transform: translateY(-50%);
}
@keyframes shake-spin {
 0% { transform: translate(0, 0) rotate(0deg); }
 20% { transform: translate(-2px, 2px) rotate(-5deg); }
 40% { transform: translate(2px, -2px) rotate(5deg); }
 60% { transform: translate(-2px, 2px) rotate(-5deg); }
 80% { transform: translate(2px, -2px) rotate(5deg); }
 100% { transform: translate(0, 0) rotate(360deg); }
}
</style>
</head>
<body class="bg-fantasy text-fantasy-deep">

<!-- =================================================================
HTMLæ§‹é€  (HTML Structure)
================================================================= -->

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
<div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
<div class="text-white text-center">
  <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mx-auto"></div>
  <p class="mt-4 text-xl font-mplus">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
</div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div id="app" class="hidden">
<header class="bg-fantasy-card p-4 shadow-md flex justify-between items-center">
  <h1 class="text-3xl"><ruby>å­¦ç¿’å†’é™ºè¨˜éŒ²<rt>ãŒãã—ã‚…ã†ã¼ã†ã‘ã‚“ãã‚ã</rt></ruby></h1>
  <div id="user-profile-header" class="text-right"></div>
</header>

<nav class="bg-fantasy-brown text-white flex justify-around">
  <button data-view="dashboard" class="nav-item flex-1 py-3 font-mplus active"><ruby>å†’é™ºã®æ›¸<rt>ã¼ã†ã‘ã‚“ã®ã—ã‚‡</rt></ruby></button>
  <button data-view="my-room" class="nav-item flex-1 py-3 font-mplus">ãƒã‚¤ãƒ«ãƒ¼ãƒ </button>
  <button data-view="plaza" class="nav-item flex-1 py-3 font-mplus">ã¿ã‚“ãªã®<ruby>åºƒå ´<rt>ã²ã‚ã°</rt></ruby></button>
</nav>

<main class="p-4">
    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ -->
  <div id="dashboard" class="view active">
    <div class="grid md:grid-cols-3 gap-6" style="height: calc(100vh - 140px);">
      <div class="md:col-span-1 flex flex-col gap-6">
        <div class="bg-fantasy-card p-4 rounded-lg shadow-lg">
          <h2 class="text-2xl text-center mb-2">ãƒã‚¤ã‚¢ãƒã‚¿ãƒ¼</h2>
          <div id="avatar-preview-main" class="relative w-full aspect-square bg-gray-200 rounded-md overflow-hidden"></div>
        </div>
        <div class="bg-fantasy-card p-4 rounded-lg shadow-lg flex-grow">
          <h3 class="text-xl font-bold">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
          <div id="user-status"></div>
        </div>
      </div>
      <div class="md:col-span-1 flex flex-col">
        <div class="bg-fantasy-card p-4 rounded-lg shadow-lg flex flex-col flex-grow min-h-0">
          <h2 class="text-2xl mb-2 flex-shrink-0">ãƒŸãƒƒã‚·ãƒ§ãƒ³</h2>
          <div id="missions-board" class="space-y-1 overflow-y-auto pr-2 flex-grow"></div>
        </div>
      </div>
      <div class="md:col-span-1 flex flex-col gap-6">
        <div class="bg-fantasy-card p-4 rounded-lg shadow-lg flex flex-col">
          <h2 class="text-2xl mb-2 flex-shrink-0">ãŠçŸ¥ã‚‰ã›</h2>
          <div id="announcements-board" class="space-y-2 pr-2"></div>
        </div>
        <div class="bg-fantasy-card p-4 rounded-lg shadow-lg flex flex-col">
          <h2 class="text-2xl mb-2 flex-shrink-0">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
          <div id="rankings-board" class="pr-2"></div>
        </div>
        <div class="bg-fantasy-card p-4 rounded-lg shadow-lg flex flex-col">
          <h2 class="text-2xl mb-2 flex-shrink-0"><ruby>æœ€è¿‘ã®è¨˜éŒ²<rt>ã•ã„ãã‚“ã®ãã‚ã</rt></ruby></h2>
          <div id="recent-activity-log" class="space-y-2 overflow-y-auto pr-2" style="height: 16.5rem;"></div>
        </div>
      </div>
    </div>
  </div>

    <!-- ãƒã‚¤ãƒ«ãƒ¼ãƒ ç”»é¢ -->
  <div id="my-room" class="view"></div>
     <!-- ã¿ã‚“ãªã®åºƒå ´ç”»é¢ -->
  <div id="plaza" class="view">
    <h2 class="text-3xl text-center mb-4">ã¿ã‚“ãªã®<ruby>åºƒå ´<rt>ã²ã‚ã°</rt></ruby></h2>
    <div id="plaza-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
  </div>
</main>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
<div id="modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
<div id="modal-content" class="bg-fantasy-card p-6 rounded-lg shadow-xl w-full max-w-lg text-center border-4 border-fantasy-brown"></div>
</div>

<!-- ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¼”å‡ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="level-up-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center overflow-hidden">
 <div id="confetti-container" class="absolute inset-0"></div>
 <div class="text-center text-white">
   <h2 class="text-6xl font-mplus celebrate-title" style="text-shadow: 0 0 15px #ffd700, 0 0 25px #ffd700;">ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</h2>
   <p id="level-up-text" class="text-8xl font-mplus celebrate-level mt-8" style="text-shadow: 0 0 15px #fff, 0 0 25px #fff;"></p>
 </div>
</div>

<!-- ã‚¬ãƒãƒ£èª­ã¿è¾¼ã¿ç”»é¢ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="gacha-loading-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center">
 <div class="gacha-capsule"></div>
 <p class="text-white mt-6 text-2xl font-mplus animate-pulse">ã‚¬ãƒãƒ£ã‚’<ruby>å›<rt>ã¾ã‚</rt></ruby>ã—ã¦ã„ã¾ã™...</p>
</div>


<!-- =================================================================
JavaScriptã‚³ãƒ¼ãƒ‰ (JavaScript Code)
================================================================= -->
<script>
// =================================================================
// 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»çŠ¶æ…‹ç®¡ç† (Global State)
// =================================================================

/** @type {Object|null} ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸå…¨ã¦ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ */
let gameData = null;

/** @type {Object} ç¾åœ¨ç·¨é›†ä¸­ã®ã‚¢ãƒã‚¿ãƒ¼æ§‹æˆã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ */
let currentAvatarComposition = {};

/** @type {string|null} ãƒã‚¤ãƒ«ãƒ¼ãƒ ã§ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ†ã‚´ãƒªã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚µãƒªã‚¿ãƒ– */
let currentActiveTab = null;


// =================================================================
// 2. åˆæœŸåŒ–å‡¦ç† (Initialization)
// =================================================================

/**
* @summary ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ¡ã‚¤ãƒ³ã®åˆæœŸåŒ–é–¢æ•°
*/
document.addEventListener('DOMContentLoaded', initialize);

/**
* @summary ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æç”»ã‚’é–‹å§‹ã™ã‚‹
*/
function initialize() {
google.script.run
  .withSuccessHandler(response => {
    if (response && response.success) {
      gameData = response;
      currentAvatarComposition = { ...gameData.avatar };
      renderAll();
      document.getElementById('app').classList.remove('hidden');

      if (response.bonusApplied) {
        showModal( `<h3>ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ï¼</h3><p class="text-xl my-4">+ ${response.bonusPoints} <ruby>çµŒé¨“å€¤<rt>ã‘ã„ã‘ã‚“ã¡</rt></ruby>ã‚’<ruby>ç²å¾—<rt>ã‹ãã¨ã</rt></ruby>ï¼</p>` );
      }
      if (response.newlyAwardedBadges && response.newlyAwardedBadges.length > 0) {
        showNewBadgeModal(response.newlyAwardedBadges);
      }
      if (response.latestLevelUp) {
        checkAndShowLevelUp(response.latestLevelUp);
      }
    } else {
      showError(response ? response.message : 'ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç„¡åŠ¹ãªå¿œç­”ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚' );
    }
    hideLoading();
  })
  .withFailureHandler(showError)
  .getGameData();
}


// =================================================================
// 3. UIãƒ¡ã‚¤ãƒ³æç”»é–¢æ•° (Main Rendering Functions)
// =================================================================

/**
* @summary ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¨ã¦ã®UIè¦ç´ ã‚’æç”»ã™ã‚‹
*/
function renderAll() {
renderHeader();
renderDashboard();
setupEventListeners();
}

/**
* @summary ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æç”»ã™ã‚‹
*/
function renderHeader() {
const p = gameData.profile;
document.getElementById('user-profile-header').innerHTML = `
  <div class="font-mplus">${p.nickname} ã•ã‚“</div>
  <div>Lv. ${p.level} | <ruby>çµŒé¨“å€¤<rt>ã‘ã„ã‘ã‚“ã¡</rt></ruby>: ${p.exp} | <ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby>Pt: ${p.exchangePoints}</div>
`;
}

/**
* @summary ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ï¼ˆå†’é™ºã®æ›¸ï¼‰ã®UIã‚’æç”»ã™ã‚‹
*/
function renderDashboard() {
const p = gameData.profile;
document.getElementById('user-status').innerHTML = `
  <p><strong>ãƒ¬ãƒ™ãƒ«:</strong> ${p.level}</p>
  <p><strong><ruby>çµŒé¨“å€¤<rt>ã‘ã„ã‘ã‚“ã¡</rt></ruby>:</strong> ${p.exp}</p>
  <p><strong><ruby>ç´¯è¨ˆ<rt>ã‚‹ã„ã‘ã„</rt></ruby>:</strong> ${p.totalExp}</p>
  <div class="mt-2">
    <p class="text-sm">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§</p>
    <div class="w-full exp-bar-bg rounded-full h-4"><div class="exp-bar-fill h-4 rounded-full" style="width: ${p.progress || 0}%"></div></div>
  </div>
`;
renderAvatarPreview('avatar-preview-main', gameData.avatar);

let mvpHtml = '<h4 class="font-bold text-amber-600">ä»Šæ—¥ã®MVPï¼</h4>' ;
if (gameData.rankings.mvp && gameData.rankings.mvp.length > 0) {
  mvpHtml += '<ol class="list-decimal list-inside text-sm">';
  gameData.rankings.mvp.forEach(r => { mvpHtml += `<li>${r.nickname} (+${r.gainedExp} EXP)</li>`; });
  mvpHtml += '</ol>';
} else {
  mvpHtml += '<p class="text-sm text-fantasy-brown">ã¾ã ä»Šæ—¥ã®<ruby>å†’é™ºè€…<rt>ã¼ã†ã‘ã‚“ã—ã‚ƒ</rt></ruby>ã¯ã„ãªã„ã‚ˆã†ã§ã™ã€‚</p>' ;
}

let top5Html = `<h4 class="font-bold mt-3"><ruby>ç·åˆ<rt>ãã†ã”ã†</rt></ruby>ãƒ¬ãƒ™ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4><ol class="list-decimal list-inside text-sm">` ;
gameData.rankings.top5.forEach(r => {
  top5Html += `<li>${r.nickname} (Lv.${r.level})</li>`;
});
top5Html += '</ol>';
document.getElementById('rankings-board').innerHTML = mvpHtml + top5Html;

document.getElementById('missions-board').innerHTML = `
  <div id="daily-missions"></div>
  <div id="weekly-missions" class="mt-4"></div>
  <div id="coop-missions" class="mt-4"></div>
`;
renderMissions();
renderRecentActivity();
renderAnnouncements();
}

/**
* @summary ãƒã‚¤ãƒ«ãƒ¼ãƒ ç”»é¢ã®UIã‚’æç”»ã™ã‚‹
*/
function renderMyRoom() {
const myRoomContainer = document.getElementById('my-room');
myRoomContainer.innerHTML = `
<div class="grid md:grid-cols-3 gap-6" style="height: 85vh;">
    <div class="bg-fantasy-card p-4 rounded-lg shadow-lg flex flex-col">
        <h2 class="text-2xl font-semibold mb-2 text-center flex-shrink-0">ã‚¢ãƒã‚¿ãƒ¼<ruby>ç·¨é›†<rt>ã¸ã‚“ã—ã‚…ã†</rt></ruby></h2>
        <div id="avatar-preview-editor" class="relative w-full aspect-square bg-gray-200 rounded-md overflow-hidden mx-auto"></div>
        <div class="text-center mt-4 space-y-2">
            <button id="save-avatar-button" class="btn-primary w-full">ã“ã®ã‚¹ã‚¿ã‚¤ãƒ«ã§<ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby></button>
            <button id="gacha-button" class="btn-gacha w-full"></button>
            <button id="gacha-10-button" class="btn-gacha10 w-full"></button>
        </div>
    </div>
    <div class="bg-fantasy-card p-4 rounded-lg shadow-lg flex flex-col min-h-0">
        <h2 class="text-2xl font-semibold mb-2 text-center flex-shrink-0">ã‚¢ã‚¤ãƒ†ãƒ </h2>
        <div id="category-tabs" class="border-b border-fantasy-brown mb-2 flex-wrap flex-shrink-0"></div>
        <div id="item-list" class="grid grid-cols-3 gap-2 flex-grow overflow-y-auto p-1"></div>
    </div>
    <div class="bg-fantasy-card p-4 rounded-lg shadow-lg flex flex-col space-y-4">
        <div class="flex-grow flex flex-col h-1/2 min-h-0">
            <h2 class="text-2xl font-semibold mb-2 text-center"><ruby>ç²å¾—<rt>ã‹ãã¨ã</rt></ruby>ã—ãŸãƒãƒƒã‚¸</h2>
            <div id="badge-collection" class="grid grid-cols-4 gap-4 overflow-y-auto p-2 flex-grow"></div>
        </div>
        <div class="flex-grow flex flex-col h-1/2 min-h-0 mt-4">
            <h2 class="text-2xl font-semibold mb-2 text-center">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
            <div class="space-y-2 flex-grow flex flex-col">
               <div class="flex-grow flex flex-col">
                   <label for="profile-motto" class="block text-sm font-bold text-fantasy-brown">ã²ã¨ã“ã¨</label>
                   <textarea id="profile-motto" rows="2" class="w-full p-1 border border-fantasy-brown rounded-md flex-grow"></textarea>
               </div>
               <div class="flex-grow flex flex-col">
                   <label for="profile-favorite" class="block text-sm font-bold text-fantasy-brown">ã™ããªã‚‚ã®</label>
                   <textarea id="profile-favorite" rows="2" class="w-full p-1 border border-fantasy-brown rounded-md flex-grow"></textarea>
               </div>
               <div class="flex-grow flex flex-col">
                   <label for="profile-goal" class="block text-sm font-bold text-fantasy-brown">ãŒã‚“ã°ã‚ŠãŸã„ã“ã¨</label>
                   <textarea id="profile-goal" rows="2" class="w-full p-1 border border-fantasy-brown rounded-md flex-grow"></textarea>
               </div>
            </div>
            <button id="save-profile-button" class="btn-primary w-full mt-3 flex-shrink-0">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’<ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby></button>
        </div>
    </div>
</div>
`;
const userProfile = gameData.userProfile;
document.getElementById('profile-motto').value = userProfile.motto;
document.getElementById('profile-favorite').value = userProfile.favorite;
document.getElementById('profile-goal').value = userProfile.goal;

document.getElementById('save-avatar-button').addEventListener('click', handleSaveAvatar);
document.getElementById('gacha-button').addEventListener('click', handleGacha);
document.getElementById('gacha-10-button').addEventListener('click', handleGacha10);
document.getElementById('save-profile-button').addEventListener('click', handleSaveProfile);

renderAvatarPreview('avatar-preview-editor', currentAvatarComposition);
renderCategoryTabs();
// â˜… ä¿®æ­£: åˆå›è¡¨ç¤ºã®ã‚¿ãƒ–ã‚’æ±ºå®š
const firstTab = document.querySelector('#category-tabs button');
if (firstTab) {
    handleCategoryClick(firstTab.dataset.tab);
}

document.getElementById('gacha-button').textContent = `ã‚¬ãƒãƒ£ (${gameData.gachaCost} EXP)`;
document.getElementById('gacha-10-button').innerHTML = `10<ruby>é€£<rt>ã‚Œã‚“</rt></ruby>ã‚¬ãƒãƒ£ (${gameData.gacha10Cost} EXP)`;

renderBadges();
}

/**
* @summary ã¿ã‚“ãªã®åºƒå ´ç”»é¢ã®UIã‚’æç”»ã™ã‚‹
*/
function renderPlaza() {
const container = document.getElementById('plaza-container');
if (!gameData.plazaData || gameData.plazaData.length === 0) {
  container.innerHTML = '<p>ã¾ã <ruby>èª°<rt>ã ã‚Œ</rt></ruby>ã‚‚ã„ãªã„ã‚ˆã†ã§ã™...</p>' ;
  return;
}

container.innerHTML = gameData.plazaData.map((user, index) => {
  const userJson = encodeURIComponent(JSON.stringify(user));
  return `
    <div class="bg-fantasy-card p-2 rounded-lg shadow text-center cursor-pointer hover:shadow-xl transition-shadow" onclick='showPlazaProfileModal(JSON.parse(decodeURIComponent("${userJson}")))'>
      <div id="plaza-avatar-${index}" class="relative w-full aspect-square bg-gray-200 rounded-md overflow-hidden mb-2"></div>
      <p class="font-bold text-sm">${user.nickname}</p>
      <p class="text-xs text-fantasy-brown">Lv. ${user.level}</p>
    </div>
  `;
}).join('');

gameData.plazaData.forEach((user, index) => {
  renderAvatarPreview(`plaza-avatar-${index}`, user.avatar);
});
}

// =================================================================
// 4. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæç”»é–¢æ•° (Component Rendering Functions)
// =================================================================

/**
* @summary ãŠçŸ¥ã‚‰ã›æ¬„ã‚’æç”»ã™ã‚‹
*/
function renderAnnouncements() {
const container = document.getElementById('announcements-board');
if (!gameData.announcements || gameData.announcements.length === 0) {
  container.innerHTML = '<p class="text-sm text-fantasy-brown">ã„ã¾ã¯ã€ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>' ;
  return;
}
container.innerHTML = gameData.announcements.map(item => {
  const date = new Date(item.timestamp);
  const formattedDate = `${date.getMonth() + 1}/${date.getDate()}`;
  return `
    <div class="border-b-2 border-dashed border-fantasy-brown pb-2 mb-2">
      <p class="text-base font-semibold text-fantasy-deep">${item.message}</p>
      <p class="text-xs text-right text-fantasy-brown mt-1">${formattedDate} by ${item.author}</p>
    </div>
  `;
}).join('');
}

/**
* @summary ã€Œæœ€è¿‘ã®è¨˜éŒ²ã€æ¬„ã‚’æç”»ã™ã‚‹
*/
function renderRecentActivity() {
const container = document.getElementById('recent-activity-log');
if (!gameData.recentActivity || gameData.recentActivity.length === 0) {
  container.innerHTML = '<p class="text-sm text-fantasy-brown">ã¾ã <ruby>è¨˜éŒ²<rt>ãã‚ã</rt></ruby>ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>' ;
  return;
}
container.innerHTML = gameData.recentActivity.map(log => {
  const date = new Date(log.timestamp);
  const formattedDate = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
  return `
    <div class="text-sm border-b border-fantasy-brown pb-1 mb-1">
      <p class="text-fantasy-deep">${log.message}</p>
      <p class="text-xs text-right text-fantasy-brown">${formattedDate}</p>
    </div>
  `;
}).join('');
}

/**
* @summary ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒœãƒ¼ãƒ‰ã‚’ç¨®é¡åˆ¥ã«æç”»ã™ã‚‹
*/
function renderMissions() {
const dailyContainer = document.getElementById('daily-missions');
const weeklyContainer = document.getElementById('weekly-missions');
const coopContainer = document.getElementById('coop-missions');

const dailyMissions = gameData.missions.filter(m => m.type === 'ãƒ‡ã‚¤ãƒªãƒ¼' );
const weeklyMissions = gameData.missions.filter(m => m.type === 'ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼' );
const coopMissions = gameData.missions.filter(m => m.type === 'å”åŠ›' );

dailyContainer.innerHTML = '<h3>ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</h3>' + (dailyMissions.length > 0 ? dailyMissions.map(renderMissionCard).join('') : '<p class="text-sm text-fantasy-brown">ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>' );
weeklyContainer.innerHTML = `<h3><ruby>ä»Šé€±<rt>ã“ã‚“ã—ã‚…ã†</rt></ruby>ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</h3>` + (weeklyMissions.length > 0 ? weeklyMissions.map(renderMissionCard).join('') : `<p class="text-sm text-fantasy-brown"><ruby>ä»Šé€±<rt>ã“ã‚“ã—ã‚…ã†</rt></ruby>ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>` );
coopContainer.innerHTML = `<h3><ruby>å”åŠ›<rt>ãã‚‡ã†ã‚Šã‚‡ã</rt></ruby>ãƒŸãƒƒã‚·ãƒ§ãƒ³</h3>` + (coopMissions.length > 0 ? coopMissions.map(renderMissionCard).join('') : `<p class="text-sm text-fantasy-brown"><ruby>å”åŠ›<rt>ãã‚‡ã†ã‚Šã‚‡ã</rt></ruby>ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>` );
}

/**
* @summary ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰1æšã®HTMLã‚’ç”Ÿæˆã™ã‚‹
* @param {Object} mission - ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
* @returns {string} ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã®HTMLæ–‡å­—åˆ—
*/
function renderMissionCard(mission) {
let buttonHtml;
if (mission.isClaimed) {
  buttonHtml = `<button class="btn-secondary btn-mission" disabled><ruby>å—å–æ¸ˆ<rt>ã†ã‘ã¨ã‚Šãšã¿</rt></ruby></button>` ;
} else if (mission.isComplete) {
  buttonHtml = `<button class="btn-claim btn-mission" onclick="handleClaimMission('${mission.id}')"><ruby>å—<rt>ã†</rt></ruby>ã‘<ruby>å–<rt>ã¨</rt></ruby>ã‚‹</button>` ;
} else {
  buttonHtml = `<button class="btn-secondary btn-mission" disabled><ruby>æŒ‘æˆ¦ä¸­<rt>ã¡ã‚‡ã†ã›ã‚“ã¡ã‚…ã†</rt></ruby></button>` ;
}

const progressPercentage = mission.target > 0 ? Math.min(100, (mission.progress / mission.target) * 100) : 0;

return `
  <div class="border border-fantasy-brown rounded-lg p-2 bg-white mt-1">
    <div class="flex justify-between items-start">
      <div class="mr-2 flex-grow">
        <p class="font-bold text-sm leading-tight">${mission.content}</p>
        <p class="text-xs text-fantasy-brown"><ruby>å ±é…¬<rt>ã»ã†ã—ã‚…ã†</rt></ruby>: ${mission.rewardType} +${mission.rewardAmount}</p>
      </div>
      <div class="flex-shrink-0">${buttonHtml}</div>
    </div>
    <div class="relative w-full h-4 mt-1.5">
      <div class="absolute w-full h-full exp-bar-bg rounded-full"></div>
      <div class="absolute h-full exp-bar-fill rounded-full" style="width: ${progressPercentage}%"></div>
      <div class="absolute w-full h-full text-center text-xs text-black font-semibold leading-4 flex items-center justify-center">
        <span>${mission.progress} / ${mission.target}</span>
      </div>
    </div>
  </div>
`;
}

/**
* @summary ç²å¾—æ¸ˆã¿ãƒãƒƒã‚¸ã®ä¸€è¦§ã‚’æç”»ã™ã‚‹
*/
function renderBadges() {
const container = document.getElementById('badge-collection');
if (!container) return;
if (!gameData.badges || gameData.badges.length === 0) {
  container.innerHTML = '<p class="text-center text-fantasy-brown">ã¾ã ãƒãƒƒã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>' ;
  return;
}
container.innerHTML = gameData.badges.map(badge => {
  const iconHtml = badge.imageUrl
    ? `<img src="${badge.imageUrl}" alt="${badge.name}" class="w-12 h-12 object-contain">`
    : '<span class="text-5xl">ğŸ†</span>';

  return `
  <div class="tooltip bg-gray-200 p-2 rounded-lg aspect-square flex flex-col items-center justify-center text-center">
    ${iconHtml}
    <span class="text-xs font-bold mt-1">${badge.name}</span>
    <span class="tooltip-text">${badge.description}</span>
  </div>
`;
}).join('');
}

/**
* @summary æŒ‡å®šã•ã‚ŒãŸè¦ç´ IDã«ã‚¢ãƒã‚¿ãƒ¼ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æç”»ã™ã‚‹
* @param {string} elementId - æç”»å…ˆã®è¦ç´ ã®ID
* @param {Object} composition - æç”»ã™ã‚‹ã‚¢ãƒã‚¿ãƒ¼ã®æ§‹æˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
*/
function renderAvatarPreview(elementId, composition) {
const previewArea = document.getElementById(elementId);
if (!previewArea) return;
previewArea.innerHTML = '';
const itemIds = Object.values(composition).filter(id => id !== null && String(id).trim() !== '');
const items = itemIds.map(id => gameData.allItems.find(item => item[ 'ã‚¢ã‚¤ãƒ†ãƒ ID' ] == id)).filter(item => item);
items.sort((a, b) => (a[ 'ãƒ¬ã‚¤ãƒ¤ãƒ¼' ] || 0) - (b[ 'ãƒ¬ã‚¤ãƒ¤ãƒ¼' ] || 0));

if (items.length === 0) {
  previewArea.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">ã‚¢ã‚¤ãƒ†ãƒ ã‚’<ruby>é¸<rt>ãˆã‚‰</rt></ruby>ã¼ã†</div>' ;
  return;
}
items.forEach(item => {
  if (item.imageUrl) {
    const img = document.createElement('img');
    img.src = item.imageUrl;
    img.className = 'absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 max-w-full max-h-full object-contain';
    img.style.zIndex = item[ 'ãƒ¬ã‚¤ãƒ¤ãƒ¼' ] || 0;
    previewArea.appendChild(img);
  }
});
}

/**
* @summary ãƒã‚¤ãƒ«ãƒ¼ãƒ ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã‚’æç”»ã™ã‚‹
*/
function renderCategoryTabs() {
    const tabsContainer = document.getElementById('category-tabs');
    if (!tabsContainer) return;

    // â˜… å¤‰æ›´: ã€Œã‚¢ã‚¯ã‚»ã‚µãƒªã€ä»¥å¤–ã®é€šå¸¸ã®ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
    const normalCategories = gameData.itemCategories.filter(c => c !== 'ã‚¢ã‚¯ã‚»ã‚µãƒª');
    
    // â˜… å¤‰æ›´: è¡¨ç¤ºã™ã‚‹ã‚¿ãƒ–ã®ãƒªã‚¹ãƒˆã‚’å®šç¾©
    const tabsToDisplay = [
        ...normalCategories,
        'ã‚¢ã‚¯ã‚»1', 'ã‚¢ã‚¯ã‚»2', 'ã‚¢ã‚¯ã‚»3' 
    ];

    tabsContainer.innerHTML = '';
    const nav = document.createElement('nav');
    nav.className = '-mb-px flex space-x-2 flex-wrap text-sm';

    tabsToDisplay.forEach(tabName => {
        const tab = document.createElement('button');
        tab.textContent = tabName;
        tab.dataset.tab = tabName; // data-category ã‹ã‚‰ data-tab ã«å¤‰æ›´
        tab.className = 'whitespace-nowrap pb-2 px-1 border-b-2 font-medium border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors';
        tab.onclick = () => handleCategoryClick(tabName);
        nav.appendChild(tab);
    });

    tabsContainer.appendChild(nav);
}

/**
* @summary æŒ‡å®šã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã®ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ã‚’æç”»ã™ã‚‹
* @param {string} displayCategory - è¡¨ç¤ºã™ã‚‹ã‚«ãƒ†ã‚´ãƒªåï¼ˆ'ã‚¢ã‚¯ã‚»ã‚µãƒª'ãªã©ï¼‰
*/
function renderItemList(displayCategory) {
    const listContainer = document.getElementById('item-list');
    if (!listContainer) return;
    listContainer.innerHTML = '';

    // â˜… å¤‰æ›´: è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒªåã‹ã‚‰å®Ÿéš›ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªåã‚’å–å¾—
    const filterCategory = ['ã‚¢ã‚¯ã‚»1', 'ã‚¢ã‚¯ã‚»2', 'ã‚¢ã‚¯ã‚»3'].includes(displayCategory) 
        ? 'ã‚¢ã‚¯ã‚»ã‚µãƒª' 
        : displayCategory;

    const filteredItems = gameData.allItems.filter(item => item['ã‚«ãƒ†ã‚´ãƒª'] === filterCategory);

    // â˜… å¤‰æ›´: ç¾åœ¨è£…å‚™ä¸­ã®ã‚¢ã‚¯ã‚»ã‚µãƒªIDã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
    const equippedAccessoryIds = ['ã‚¢ã‚¯ã‚»1_ã‚¢ã‚¤ãƒ†ãƒ ID', 'ã‚¢ã‚¯ã‚»2_ã‚¢ã‚¤ãƒ†ãƒ ID', 'ã‚¢ã‚¯ã‚»3_ã‚¢ã‚¤ãƒ†ãƒ ID']
        .map(key => currentAvatarComposition[key])
        .filter(id => id);

    filteredItems.forEach(item => {
        const isInitialItem = String(item['å¿…è¦äº¤æ›ãƒã‚¤ãƒ³ãƒˆ']) === '0';
        const hasItem = gameData.inventory.includes(item['ã‚¢ã‚¤ãƒ†ãƒ ID']) || isInitialItem;
        
        // â˜… å¤‰æ›´: è£…å‚™ä¸­ã‹ã©ã†ã‹ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›´æ–°
        let isEquipped = false;
        if (filterCategory === 'ã‚¢ã‚¯ã‚»ã‚µãƒª') {
            isEquipped = equippedAccessoryIds.includes(item['ã‚¢ã‚¤ãƒ†ãƒ ID']);
        } else {
            const categoryKey = `${filterCategory}_ã‚¢ã‚¤ãƒ†ãƒ ID`;
            isEquipped = currentAvatarComposition[categoryKey] === item['ã‚¢ã‚¤ãƒ†ãƒ ID'];
        }

        const exchangeCost = Number(item['å¿…è¦äº¤æ›ãƒã‚¤ãƒ³ãƒˆ'] || 0);

        const card = document.createElement('div');
        card.className = `group relative border rounded-lg p-2 cursor-pointer transition-all ${isEquipped ? 'border-blue-500 ring-2 ring-blue-500' : 'border-gray-200'} ${hasItem ? 'bg-white' : 'bg-gray-100'}`;
        card.onclick = () => handleItemClick(item);

        let overlay = '';
        if (!hasItem) {
            if (exchangeCost > 0) {
                overlay = `<div class="absolute inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center text-white p-1 rounded-lg"><span class="font-bold text-sm">${exchangeCost} Ptã§<ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby></span></div>`;
            } else if (item['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼']) {
                overlay = `<div class="absolute inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center text-white p-1 rounded-lg"><span class="font-semibold text-xs text-center">ã‚¬ãƒãƒ£ã§<ruby>å…¥æ‰‹<rt>ã«ã‚…ã†ã—ã‚…</rt></ruby></span></div>`;
            }
        }

        card.innerHTML = `
            <div class="aspect-square flex items-center justify-center">
                <img src="${item.imageUrl || ''}" alt="${item['ã‚¢ã‚¤ãƒ†ãƒ å']}" class="max-w-full max-h-full object-contain ${hasItem ? '' : 'opacity-50'}">
            </div>
            <p class="text-xs text-center mt-1 h-4 truncate group-hover:whitespace-normal group-hover:text-clip">${item['ã‚¢ã‚¤ãƒ†ãƒ å'] || ''}</p>
            ${overlay}
        `;
        listContainer.appendChild(card);
    });
}


// =================================================================
// 5. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨ãƒãƒ³ãƒ‰ãƒ© (Event Listeners & Handlers)
// =================================================================

/**
* @summary ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹
*/
function setupEventListeners() {
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', e => {
    const viewName = e.target.dataset.view;
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    e.target.classList.add('active');
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(viewName).classList.add('active');

    if (viewName === 'my-room') {
      renderMyRoom();
    } else if (viewName === 'plaza') {
      renderPlaza();
    }
  });
});
}

/**
* @summary ãƒŸãƒƒã‚·ãƒ§ãƒ³ã®å ±é…¬å—ã‘å–ã‚Šãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
* @param {string} missionId - å ±é…¬ã‚’å—ã‘å–ã‚‹ãƒŸãƒƒã‚·ãƒ§ãƒ³ã®ID
*/
function handleClaimMission(missionId) {
 const cleanedMissionId = missionId.trim();
 showLoading();
 google.script.run
   .withSuccessHandler(res => {
     hideLoading();
     if (res.success) {
       gameData.profile.exp = res.newExp;
       gameData.profile.totalExp = res.newTotalExp;
       gameData.profile.exchangePoints = res.newExchangePoints;
       const mission = gameData.missions.find(m => m.id === cleanedMissionId);
       if (mission) {
         mission.isClaimed = true;
       }
       renderHeader();
       renderDashboard();
       showModal( `<h3>ãƒŸãƒƒã‚·ãƒ§ãƒ³<ruby>é”æˆ<rt>ãŸã£ã›ã„</rt></ruby>ï¼</h3><p>${res.message}</p>`);
     } else {
       showError(res.message);
     }
   })
   .withFailureHandler(showError)
   .claimMissionReward(cleanedMissionId);
}

/**
* @summary ãƒã‚¤ãƒ«ãƒ¼ãƒ ã§ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
* @param {string} tabName - é¸æŠã•ã‚ŒãŸã‚¿ãƒ–å
*/
function handleCategoryClick(tabName) {
    currentActiveTab = tabName;
    document.querySelectorAll('#category-tabs button').forEach(button => {
        button.classList.toggle('border-blue-500', button.dataset.tab === tabName);
        button.classList.toggle('text-blue-600', button.dataset.tab === tabName);
    });
    // â˜… å¤‰æ›´: ã©ã®ã‚¿ãƒ–ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¦ã‚‚ renderItemList ã‚’å‘¼ã³å‡ºã™
    renderItemList(tabName);
}

/**
* @summary ãƒã‚¤ãƒ«ãƒ¼ãƒ ã§ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
* @param {Object} item - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ‡ãƒ¼ã‚¿
*/
function handleItemClick(item) {
    const isInitialItem = String(item['å¿…è¦äº¤æ›ãƒã‚¤ãƒ³ãƒˆ']) === '0';
    const hasItem = gameData.inventory.includes(item['ã‚¢ã‚¤ãƒ†ãƒ ID']) || isInitialItem;

    if (hasItem) {
        // â˜…â˜…â˜…â˜…â˜… ã“ã“ã‹ã‚‰å¤§å¹…ã«å¤‰æ›´ â˜…â˜…â˜…â˜…â˜…
        if (item['ã‚«ãƒ†ã‚´ãƒª'] === 'ã‚¢ã‚¯ã‚»ã‚µãƒª') {
            const clickedItemId = item['ã‚¢ã‚¤ãƒ†ãƒ ID'];
            const accessorySlots = ['ã‚¢ã‚¯ã‚»1_ã‚¢ã‚¤ãƒ†ãƒ ID', 'ã‚¢ã‚¯ã‚»2_ã‚¢ã‚¤ãƒ†ãƒ ID', 'ã‚¢ã‚¯ã‚»3_ã‚¢ã‚¤ãƒ†ãƒ ID'];
            const activeSlotKey = `${currentActiveTab}_ã‚¢ã‚¤ãƒ†ãƒ ID`;

            // ä»–ã®ã‚¹ãƒ­ãƒƒãƒˆã§æ—¢ã«åŒã˜ã‚¢ã‚¤ãƒ†ãƒ ã‚’è£…å‚™ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const isDuplicate = accessorySlots.some(slotKey => 
                slotKey !== activeSlotKey && currentAvatarComposition[slotKey] === clickedItemId
            );

            if (isDuplicate) {
                showModal('<h3>ã‚¨ãƒ©ãƒ¼</h3><p>ã“ã®ã‚¢ã‚¯ã‚»ã‚µãƒªã¯ã€ã™ã§ã«åˆ¥ã®ã°ã—ã‚‡ã«ã¤ã‘ã¦ã„ã¾ã™ã€‚</p>', true);
                return;
            }

            // ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ãƒ­ãƒƒãƒˆã§è£…å‚™/è§£é™¤
            if (currentAvatarComposition[activeSlotKey] === clickedItemId) {
                // åŒã˜ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã®ã§è§£é™¤
                delete currentAvatarComposition[activeSlotKey];
            } else {
                // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’è£…å‚™
                currentAvatarComposition[activeSlotKey] = clickedItemId;
            }

        } else {
            // ã‚¢ã‚¯ã‚»ã‚µãƒªä»¥å¤–ã®é€šå¸¸ã®ã‚¢ã‚¤ãƒ†ãƒ ã®å‡¦ç†
            const itemCategoryKey = `${item['ã‚«ãƒ†ã‚´ãƒª'].trim()}_ã‚¢ã‚¤ãƒ†ãƒ ID`;
            if (currentAvatarComposition[itemCategoryKey] === item['ã‚¢ã‚¤ãƒ†ãƒ ID']) {
                delete currentAvatarComposition[itemCategoryKey];
            } else {
                currentAvatarComposition[itemCategoryKey] = item['ã‚¢ã‚¤ãƒ†ãƒ ID'];
            }
        }
        // â˜…â˜…â˜…â˜…â˜… ã“ã“ã¾ã§å¤§å¹…ã«å¤‰æ›´ â˜…â˜…â˜…â˜…â˜…

        renderAvatarPreview('avatar-preview-editor', currentAvatarComposition);
        renderItemList(currentActiveTab);

    } else if (Number(item['å¿…è¦äº¤æ›ãƒã‚¤ãƒ³ãƒˆ'] || 0) > 0) {
        showModal(`
    <h3>ã‚¢ã‚¤ãƒ†ãƒ <ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby></h3>
    <p class="my-4">${item['ã‚¢ã‚¤ãƒ†ãƒ å']}ã‚’${item['å¿…è¦äº¤æ›ãƒã‚¤ãƒ³ãƒˆ']}<ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby>ãƒã‚¤ãƒ³ãƒˆã§<ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby>ã—ã¾ã™ã‹ï¼Ÿ</p>
    <div class="flex justify-center gap-4">
      <button id="confirm-exchange" class="btn-primary"><ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby>ã™ã‚‹</button>
      <button id="cancel-exchange" class="btn-secondary">ã‚„ã‚ã‚‹</button>
    </div>`, false);
        document.getElementById('confirm-exchange').onclick = () => { hideModal(); runExchangeItem(item['ã‚¢ã‚¤ãƒ†ãƒ ID']); };
        document.getElementById('cancel-exchange').onclick = hideModal;
    }
}


/**
* @summary ã‚¢ãƒã‚¿ãƒ¼ã®ä¿å­˜ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
*/
function handleSaveAvatar() {
showLoading();
google.script.run
  .withSuccessHandler(res => {
    hideLoading();
    if (res.success) {
      gameData.avatar = { ...currentAvatarComposition };
      renderAvatarPreview('avatar-preview-main', gameData.avatar);
      showModal( '<h3><ruby>æˆåŠŸ<rt>ã›ã„ã“ã†</rt></ruby></h3><p>ã‚¢ãƒã‚¿ãƒ¼ã‚’<ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby>ã—ã¾ã—ãŸï¼</p>' );
    } else {
      showError(res.message);
    }
  })
  .withFailureHandler(showError)
  .saveAvatar(currentAvatarComposition);
}

/**
* @summary ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ä¿å­˜ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
*/
function handleSaveProfile() {
showLoading();
const profileData = {
  motto: document.getElementById('profile-motto').value,
  favorite: document.getElementById('profile-favorite').value,
  goal: document.getElementById('profile-goal').value,
};
google.script.run
  .withSuccessHandler(res => {
    hideLoading();
    if (res.success) {
      gameData.userProfile = profileData;
      showModal( '<h3><ruby>æˆåŠŸ<rt>ã›ã„ã“ã†</rt></ruby></h3><p>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’<ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby>ã—ã¾ã—ãŸï¼</p>' );
    } else {
      showError(res.message);
    }
  })
  .withFailureHandler(showError)
  .saveProfile(profileData);
}

/**
* @summary ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
*/
function handleGacha() {
showModal(`
  <h3>ã‚¬ãƒãƒ£</h3><p class="my-4">${gameData.gachaCost}<ruby>çµŒé¨“å€¤<rt>ã‘ã„ã‘ã‚“ã¡</rt></ruby>ã‚’<ruby>æ¶ˆè²»<rt>ã—ã‚‡ã†ã²</rt></ruby>ã—ã¦ã‚¬ãƒãƒ£ã‚’<ruby>å›<rt>ã¾ã‚</rt></ruby>ã—ã¾ã™ã‹ï¼Ÿ</p>
  <div class="flex justify-center gap-4"> <button id="confirm" class="btn-gacha"><ruby>å›<rt>ã¾ã‚</rt></ruby>ã™</button> <button id="cancel" class="btn-secondary">ã‚„ã‚ã‚‹</button></div>` , false);
document.getElementById('confirm').onclick = () => { hideModal(); runGacha('playGacha'); };
document.getElementById('cancel').onclick = hideModal;
}

/**
* @summary 10é€£ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
*/
function handleGacha10() {
showModal(`
  <h3>10<ruby>é€£<rt>ã‚Œã‚“</rt></ruby>ã‚¬ãƒãƒ£</h3><p class="my-4">${gameData.gacha10Cost}<ruby>çµŒé¨“å€¤<rt>ã‘ã„ã‘ã‚“ã¡</rt></ruby>ã‚’<ruby>æ¶ˆè²»<rt>ã—ã‚‡ã†ã²</rt></ruby>ã—ã¦10<ruby>é€£<rt>ã‚Œã‚“</rt></ruby>ã‚¬ãƒãƒ£ã‚’<ruby>å›<rt>ã¾ã‚</rt></ruby>ã—ã¾ã™ã‹ï¼Ÿ</p>
  <div class="flex justify-center gap-4"><button id="confirm" class="btn-gacha10"><ruby>å›<rt>ã¾ã‚</rt></ruby>ã™</button><button id="cancel" class="btn-secondary">ã‚„ã‚ã‚‹</button></div>` , false);
document.getElementById('confirm').onclick = () => { hideModal(); runGacha('playGacha10'); };
document.getElementById('cancel').onclick = hideModal;
}

// =================================================================
// 6. ã‚µãƒ¼ãƒãƒ¼é€šä¿¡å®Ÿè¡Œé–¢æ•° (Server Call Executors)
// =================================================================

/**
* @summary ã‚¢ã‚¤ãƒ†ãƒ äº¤æ›å‡¦ç†ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹
* @param {string} itemId - äº¤æ›ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã®ID
*/
function runExchangeItem(itemId) {
showLoading();
google.script.run
  .withSuccessHandler(res => {
    hideLoading();
    if (res.success) {
      gameData.profile.exchangePoints = res.newExchangePoints;
      gameData.inventory.push(itemId);
      renderHeader();
      renderItemList(currentActiveTab);
      showModal( `<h3><ruby>äº¤æ›å®Œäº†<rt>ã“ã†ã‹ã‚“ã‹ã‚“ã‚Šã‚‡ã†</rt></ruby></h3><p>${res.message}</p>`);
    } else {
      showModal( `<h3><ruby>å¤±æ•—<rt>ã—ã£ã±ã„</rt></ruby></h3><p>${res.message}</p>`);
    }
  })
  .withFailureHandler(showError)
  .exchangeItem(itemId);
}

/**
* @summary ã‚¬ãƒãƒ£ã¾ãŸã¯10é€£ã‚¬ãƒãƒ£ã®å®Ÿè¡Œã‚’ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹
* @param {'playGacha' | 'playGacha10'} functionName - å®Ÿè¡Œã™ã‚‹ã‚µãƒ¼ãƒãƒ¼å´é–¢æ•°å
*/
function runGacha(functionName) {
showGachaLoading();
google.script.run
  .withSuccessHandler(res => {
    hideGachaLoading();
    if (res.success) {
      gameData.profile.exp = res.newPoints;
      if (res.newExchangePoints !== undefined) gameData.profile.exchangePoints = res.newExchangePoints;

      if (functionName === 'playGacha10') {
        res.results.forEach(item => { if (!item.isDuplicate) gameData.inventory.push(item[ 'ã‚¢ã‚¤ãƒ†ãƒ ID' ]); });
        showGacha10Result(res);
      } else {
        if (!res.isDuplicate) gameData.inventory.push(res.wonItem[ 'ã‚¢ã‚¤ãƒ†ãƒ ID' ]);
        showGachaResult(res);
      }
      renderHeader();
      if (currentActiveTab) renderItemList(currentActiveTab);
    } else {
      showModal( `<h3><ruby>å¤±æ•—<rt>ã—ã£ã±ã„</rt></ruby></h3><p>${res.message}</p>`);
    }
  })
  .withFailureHandler(showError)
  [functionName]();
}

// =================================================================
// 7. UIãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (UI Helpers)
// =================================================================

/**
* @summary ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
*/
function showLoading() { document.getElementById('loading').classList.remove('hidden'); }

/**
* @summary ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
*/
function hideLoading() { document.getElementById('loading').classList.add('hidden'); }

/**
* @summary ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’éè¡¨ç¤ºã«ã™ã‚‹
*/
function hideModal() { document.getElementById('modal').classList.add('hidden'); }

/**
* @summary ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã™ã‚‹
* @param {Error|string} error - è¡¨ç¤ºã™ã‚‹ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
*/
function showError(error) {
hideLoading();
hideGachaLoading();
const message = error.message || JSON.stringify(error);
console.error(message);
showModal( `<h2>ã‚¨ãƒ©ãƒ¼</h2><p class="my-4">å•é¡ŒãŒ<ruby>ç™ºç”Ÿ<rt>ã¯ã£ã›ã„</rt></ruby>ã—ã¾ã—ãŸã€‚</p><pre class="text-xs text-left bg-gray-100 p-2 rounded">${message}</pre>`, false);
}

/**
* @summary æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤ºã™ã‚‹
* @param {string} content - ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã™ã‚‹HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„
* @param {boolean} [autoClose=true] - 3ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹ã‹ã©ã†ã‹
*/
function showModal(content, autoClose = true) {
const modal = document.getElementById('modal');
modal.classList.remove('hidden');
document.getElementById('modal-content').innerHTML = `${content} <button id="modal-close" class="btn-secondary mt-4">ã¨ã˜ã‚‹</button>` ;
document.getElementById('modal-close').onclick = hideModal;
if (autoClose) setTimeout(hideModal, 3000);
}

/**
* @summary ã¿ã‚“ãªã®åºƒå ´ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
* @param {Object} user - è¡¨ç¤ºã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿
*/
function showPlazaProfileModal(user) {
const profile = user.profile;
const content = `
  <div class="flex flex-col items-center">
    <div id="modal-avatar-preview" class="relative w-40 h-40 bg-gray-200 rounded-md overflow-hidden mb-3"></div>
    <h3 class="text-2xl">${user.nickname} <span class="text-lg text-fantasy-brown">Lv. ${user.level}</span></h3>
    <div class="text-left w-full bg-white p-3 rounded-lg mt-3 space-y-2 border border-fantasy-brown">
      <div>
        <h4 class="font-bold text-fantasy-brown">ã²ã¨ã“ã¨</h4>
        <p class="pl-2">${profile.motto || 'ã¾ã <ruby>è¨­å®š<rt>ã›ã£ã¦ã„</rt></ruby>ã•ã‚Œã¦ã„ã¾ã›ã‚“' }</p>
      </div>
      <div>
        <h4 class="font-bold text-fantasy-brown">ã™ããªã‚‚ã®</h4>
        <p class="pl-2">${profile.favorite || 'ã¾ã <ruby>è¨­å®š<rt>ã›ã£ã¦ã„</rt></ruby>ã•ã‚Œã¦ã„ã¾ã›ã‚“' }</p>
      </div>
      <div>
        <h4 class="font-bold text-fantasy-brown">ãŒã‚“ã°ã‚ŠãŸã„ã“ã¨</h4>
        <p class="pl-2">${profile.goal || 'ã¾ã <ruby>è¨­å®š<rt>ã›ã£ã¦ã„</rt></ruby>ã•ã‚Œã¦ã„ã¾ã›ã‚“' }</p>
      </div>
    </div>
  </div>
`;
showModal(content, false);
renderAvatarPreview('modal-avatar-preview', user.avatar);
}

/**
* @summary æ–°è¦ç²å¾—ãƒãƒƒã‚¸ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
* @param {Object[]} badges - æ–°ãŸã«ç²å¾—ã—ãŸãƒãƒƒã‚¸ã®ãƒ‡ãƒ¼ã‚¿é…åˆ—
*/
function showNewBadgeModal(badges) {
const badgeHtml = badges.map(badge => `
  <div class="border-2 border-yellow-400 rounded-lg p-4 my-2">
    <p class="text-3xl">ğŸ†</p>
    <p class="font-bold text-xl">${badge.name}</p>
    <p class="text-sm text-fantasy-brown">${badge.description}</p>
  </div>
`).join('');
showModal(`
  <h2 class="text-3xl text-yellow-500 animate-bounce"><ruby>å®Ÿç¸¾è§£é™¤<rt>ã˜ã£ã›ãã‹ã„ã˜ã‚‡</rt></ruby>ï¼</h2>
  ${badgeHtml}
`, false);
}

/**
* @summary å˜ç™ºã‚¬ãƒãƒ£ã®çµæœã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã™ã‚‹
* @param {Object} res - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¬ãƒãƒ£çµæœãƒ¬ã‚¹ãƒãƒ³ã‚¹
*/
function showGachaResult(res) {
const item = res.wonItem;
let content;
if (res.isDuplicate) {
  content = `<h3>ã‚¢ã‚¤ãƒ†ãƒ <ruby>é‡è¤‡<rt>ã˜ã‚…ã†ãµã</rt></ruby>ï¼</h3>
  <p class="my-2">${item[ 'ã‚¢ã‚¤ãƒ†ãƒ å' ]}</p>
  <p class="text-lg font-bold text-green-500">+${res.awardedExchangePoints} <ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby>ãƒã‚¤ãƒ³ãƒˆ</p>` ;
} else {
  let rarityColor = res.wonItem[ 'ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼' ] === 'SR' ? 'text-yellow-400' : (res.wonItem[ 'ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼' ] === 'R' ? 'text-blue-500' : 'text-gray-500');
  content = `<h3 class="text-2xl font-bold mb-2 animate-bounce">GET!</h3>
  <div class="p-4"><img src="${item.imageUrl || ''}" class="mx-auto h-32 w-32 object-contain"></div>
  <p class="text-lg font-bold">${item[ 'ã‚¢ã‚¤ãƒ†ãƒ å' ]}</p>
  <p class="font-bold text-xl ${rarityColor} ">ãƒ¬ã‚¢ãƒªãƒ†ã‚£: ${item[ 'ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼' ]}</p>`;
}
showModal(content, false);
}

/**
* @summary 10é€£ã‚¬ãƒãƒ£ã®çµæœã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã™ã‚‹
* @param {Object} res - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®10é€£ã‚¬ãƒãƒ£çµæœãƒ¬ã‚¹ãƒãƒ³ã‚¹
*/
function showGacha10Result(res) {
let resultsHtml = res.results.map(item => {
  let rarityClass = item[ 'ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼' ] === 'SR' ? 'is-sr' : (item[ 'ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼' ] === 'R' ? 'is-r' : '');
  let duplicateHtml = item.isDuplicate ? `<div class="duplicate-overlay"><span>+${item.awardedPoints} Pt</span></div>` : '';
  return `<div class="gacha-item-card ${rarityClass}"><img src="${item.imageUrl || ''}" alt="${item[ 'ã‚¢ã‚¤ãƒ†ãƒ å' ]}">${duplicateHtml}</div>`;
}).join('');

const summary = res.summary;
let summaryHtml = `<h3 class="text-xl font-bold mb-2">ã‚¬ãƒãƒ£<ruby>çµæœ<rt>ã‘ã£ã‹</rt></ruby></h3>
  ${summary.newItemsCount > 0 ? `<p class="text-lg"><ruby>æ–°<rt>ã‚ãŸã‚‰</rt></ruby>ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’<span class="font-bold text-blue-600"> ${summary.newItemsCount} <ruby>å€‹<rt>ã“</rt></ruby></span>GETï¼</p>` : ''}
  ${summary.awardedExchangePoints > 0 ? `<p class="text-lg"><span class="font-bold text-green-600">${summary.awardedExchangePoints} <ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby>ãƒã‚¤ãƒ³ãƒˆ</span>ã‚’<ruby>ç²å¾—<rt>ã‹ãã¨ã</rt></ruby>ï¼</p>` : ''}`;
showModal(`${summaryHtml}<div class="gacha-results-grid my-4">${resultsHtml}</div>`, false);
}

/**
* @summary ã‚¬ãƒãƒ£å®Ÿè¡Œä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
*/
function showGachaLoading() {
 document.getElementById('gacha-loading-modal').classList.remove('hidden');
}

/**
* @summary ã‚¬ãƒãƒ£å®Ÿè¡Œä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
*/
function hideGachaLoading() {
 document.getElementById('gacha-loading-modal').classList.add('hidden');
}

/**
* @summary æœ€æ–°ã®ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æƒ…å ±ã‚’ç¢ºèªã—ã€å¿…è¦ã§ã‚ã‚Œã°ãŠç¥ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
* @param {Object} latestLevelUp - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸæœ€æ–°ã®ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æƒ…å ±
*/
function checkAndShowLevelUp(latestLevelUp) {
 const lastShownTimestamp = localStorage.getItem('lastShownLevelUpTimestamp');
 if (latestLevelUp.timestamp !== lastShownTimestamp) {
   showLevelUpModal(latestLevelUp.newLevel);
   localStorage.setItem('lastShownLevelUpTimestamp', latestLevelUp.timestamp);
 }
}

/**
* @summary ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã®ãŠç¥ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
* @param {number} newLevel - æ–°ã—ã„ãƒ¬ãƒ™ãƒ«
*/
function showLevelUpModal(newLevel) {
 const modal = document.getElementById('level-up-modal');
 const levelText = document.getElementById('level-up-text');
 const confettiContainer = document.getElementById('confetti-container');
  levelText.textContent = `Lv. ${newLevel}`;
 modal.classList.remove('hidden');
   // ç´™å¹é›ªã‚’ç”Ÿæˆ
 confettiContainer.innerHTML = '';
 for (let i = 0; i < 100; i++) {
   const confetti = document.createElement('div');
   confetti.className = 'confetti-piece';
   const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];
   confetti.style.left = Math.random() * 100 + 'vw';
   confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
   confetti.style.animation = `confetti-fall ${Math.random() * 2 + 3}s linear ${Math.random() * 2}s infinite`;
   confettiContainer.appendChild(confetti);
 }

  // 5ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
 setTimeout(() => {
   modal.classList.add('hidden');
   confettiContainer.innerHTML = '';  // ç´™å¹é›ªã‚’å‰Šé™¤
 }, 5000);
}

</script>
</body>
</html>

