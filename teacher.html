<!DOCTYPE html>
<html>
<head>
<base target="_top">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
/* 基本フォント設定 */
body { font-family: 'Noto Sans JP', sans-serif; }
h1, h2, h3, .font-mplus { font-family: 'Mochiy Pop One', sans-serif; }

/* ボタン共通スタイル */
.btn-primary { background-color: #2563eb; color: white; padding: 8px 16px; border-radius: 6px; box-shadow: 0 2px #1d4ed8; transition: all 0.2s; }
.btn-primary:hover:not(:disabled) { background-color: #1e40af; transform: translateY(1px); box-shadow: 0 1px #1e3a8a; }
.btn-primary:disabled { background-color: #9ca3af; cursor: not-allowed; box-shadow: none; }
.btn-danger { background-color: #dc2626; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; }
.btn-secondary { background-color: #6b7280; color: white; padding: 8px 16px; border-radius: 6px; box-shadow: 0 2px #4b5563; transition: all 0.2s; }
.btn-secondary:hover { background-color: #4b5563; }

/* その他UI要素のスタイル */
.exp-bar-bg { background-color: #e5e7eb; }
.exp-bar-fill { background: linear-gradient(90deg, #ffd700, #ffec80); }
</style>
</head>
<body class="bg-gray-100 p-8">

<!-- =================================================================
HTML構造 (HTML Structure)
================================================================= -->

<!-- ローディング画面 -->
<div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
   <div class="text-white text-center">
       <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-white mx-auto"></div>
       <p class="mt-4 text-lg"><ruby>処理中<rt>しょりちゅう</rt></ruby>...</p>
   </div>
</div>

<!-- 児童詳細モーダル -->
<div id="student-detail-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
   <div id="student-detail-content" class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl text-left border-4 border-blue-300 relative max-h-[90vh] flex flex-col">
       <!-- Content will be injected by JS -->
   </div>
</div>


<div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-lg">
   <h1 class="text-3xl font-mplus text-gray-800 mb-6">教員用ダッシュボード</h1>

   <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- 児童の詳細を確認 -->
       <div class="md:col-span-1 bg-purple-50 p-4 rounded-lg border border-purple-200">
           <h2 class="text-xl font-mplus text-purple-800 mb-3">児童の詳細を確認</h2>
           <div class="space-y-4">
               <div>
                   <label for="student-detail-select" class="block text-sm font-bold text-gray-700">児童を選択</label>
                   <select id="student-detail-select" class="w-full p-2 border border-gray-300 rounded-md mt-1">
                       <option value="">-- 児童を選択 --</option>
                   </select>
               </div>
               <button id="view-student-detail-btn" class="btn-primary w-full bg-purple-600 hover:bg-purple-800 box-shadow-purple-800">詳細を見る</button>
           </div>
       </div>

        <!-- ポイントを配布する -->
       <div class="md:col-span-1 bg-yellow-50 p-4 rounded-lg border border-yellow-200">
           <h2 class="text-xl font-mplus text-yellow-800 mb-3">ポイントを配布する</h2>
           <div class="space-y-4">
               <div>
                   <label class="block text-sm font-bold text-gray-700">児童を選択（複数可）</label>
                   <div class="border border-gray-300 rounded-md mt-1 p-2 h-40 overflow-y-auto bg-white">
                       <div class="mb-2 pb-2 border-b">
                           <label class="flex items-center"><input type="checkbox" id="select-all-students" class="mr-2 h-4 w-4">全員を選択 / 解除</label>
                       </div>
                       <div id="student-list" class="space-y-1"></div>
                   </div>
               </div>
               <div>
                   <label class="block text-sm font-bold text-gray-700">ポイント種別</label>
                   <div class="flex gap-4 mt-1">
                       <label class="flex items-center"><input type="radio" name="point_type" value="exp" class="mr-1" checked>経験値</label>
                       <label class="flex items-center"><input type="radio" name="point_type" value="exchange" class="mr-1">交換ポイント</label>
                   </div>
               </div>
               <div>
                   <label for="point-amount" class="block text-sm font-bold text-gray-700">配布量</label>
                   <input type="number" id="point-amount" class="w-full p-2 border border-gray-300 rounded-md mt-1" placeholder="例: 100">
               </div>
                <div>
                   <label for="grant-reason" class="block text-sm font-bold text-gray-700">理由（ログに残ります）</label>
                   <input type="text" id="grant-reason" class="w-full p-2 border border-gray-300 rounded-md mt-1" placeholder="例: 授業でのすばらしい発表">
               </div>
               <button id="grant-point-btn" class="btn-primary w-full">配布する</button>
           </div>
       </div>

        <!-- お知らせを投稿する -->
       <div class="md:col-span-1 bg-blue-50 p-4 rounded-lg border border-blue-200">
           <h2 class="text-xl font-mplus text-blue-800 mb-3">お知らせを投稿する</h2>
           <div class="space-y-4">
               <div>
                   <label for="announcement-message" class="block text-sm font-bold text-gray-700">メッセージ内容</label>
                   <textarea id="announcement-message" rows="4" class="w-full p-2 border border-gray-300 rounded-md mt-1" placeholder="児童に表示するメッセージを入力"></textarea>
               </div>
               <div>
                   <label for="display-until" class="block text-sm font-bold text-gray-700">表示終了日（任意）</label>
                   <input type="date" id="display-until" class="w-full p-2 border border-gray-300 rounded-md mt-1">
               </div>
               <button id="post-announcement-btn" class="btn-primary w-full">投稿する</button>
           </div>
       </div>

        <!-- 現在のお知らせ -->
       <div class="md:col-span-1 bg-green-50 p-4 rounded-lg border border-green-200">
           <h2 class="text-xl font-mplus text-green-800 mb-3">現在のお知らせ</h2>
           <div id="announcements-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
       </div>
   </div>
</div>

<!-- =================================================================
JavaScriptコード (JavaScript Code)
================================================================= -->
<script>
// =================================================================
// 1. グローバル変数・状態管理 (Global State)
// =================================================================

/** @type {string} ログインしている教員の名前 */
let teacherName = '';

/** @type {Object[]} クラスの全児童のリスト {number, nickname, email} */
let studentsList = [];


// =================================================================
// 2. 初期化処理 (Initialization)
// =================================================================

/**
 * @summary ページの読み込み完了時に実行されるメインの初期化関数
 */
document.addEventListener('DOMContentLoaded', initializeTeacherDashboard);

/**
 * @summary サーバーから初期データを取得し、ダッシュボードの描画とイベントリスナーの設定を行う
 */
function initializeTeacherDashboard() {
  showLoading();
  google.script.run
      .withSuccessHandler(data => {
          hideLoading();
          if (data.success) {
              teacherName = data.teacherName;
              studentsList = data.students;
              renderAnnouncements(data.announcements);
              populateStudentList(studentsList);
              populateStudentDetailSelect(studentsList);
              setupEventListeners();
          } else {
              alert('エラー: ' + data.message);
          }
      })
      .withFailureHandler(handleError)
      .getTeacherData();
}

/**
 * @summary ダッシュボード内のボタンにイベントリスナーを設定する
 */
function setupEventListeners() {
    document.getElementById('post-announcement-btn').addEventListener('click', handlePostAnnouncement);
    document.getElementById('grant-point-btn').addEventListener('click', handleGrantPoint);
    document.getElementById('select-all-students').addEventListener('change', toggleAllStudents);
    document.getElementById('view-student-detail-btn').addEventListener('click', handleViewStudentDetail);
}

// =================================================================
// 3. UI描画関数 (UI Rendering Functions)
// =================================================================

/**
 * @summary ポイント配布用の児童選択チェックボックスリストを描画する
 * @param {Object[]} students - 児童リスト
 */
function populateStudentList(students) {
   const listEl = document.getElementById('student-list');
   listEl.innerHTML = '';
   if (!students || students.length === 0) {
       listEl.innerHTML = '<p class="text-gray-500">児童が登録されていません。</p>';
       return;
   }
   students.forEach(student => {
       const label = document.createElement('label');
       label.className = 'flex items-center w-full p-1 rounded hover:bg-yellow-100 cursor-pointer';
       label.innerHTML = `
           <input type="checkbox" class="student-checkbox mr-2 h-4 w-4" value="${escapeHtml(student.email)}">
           <span>${escapeHtml(student.number)}番 ${escapeHtml(student.nickname)}</span>
       `;
       listEl.appendChild(label);
   });
}

/**
 * @summary 児童詳細確認用のドロップダウンリストを描画する
 * @param {Object[]} students - 児童リスト
 */
function populateStudentDetailSelect(students) {
   const selectEl = document.getElementById('student-detail-select');
   selectEl.innerHTML = '<option value="">-- 児童を選択 --</option>';
   if (!students || students.length === 0) return;

   students.forEach(student => {
       const option = document.createElement('option');
       option.value = student.email;
       option.textContent = `${student.number}番 ${student.nickname}`;
       selectEl.appendChild(option);
   });
}

/**
 * @summary 現在表示中のお知らせリストを描画する
 * @param {Object[]} announcements - お知らせの配列
 */
function renderAnnouncements(announcements) {
  const listEl = document.getElementById('announcements-list');
  if (!announcements || announcements.length === 0) {
      listEl.innerHTML = '<p class="text-gray-500">現在表示中のお知らせはありません。</p>';
      return;
  }

  listEl.innerHTML = announcements.map((item) => {
      const postDate = new Date(item.timestamp).toLocaleDateString('ja-JP');
      const endDate = item.endDate ? new Date(item.endDate).toLocaleDateString('ja-JP') : '無期限';
      return `
          <div class="bg-white p-3 rounded-md shadow-sm border">
              <p class="text-gray-800">${escapeHtml(item.message)}</p>
              <div class="text-xs text-gray-500 mt-2 flex justify-between items-center">
                  <span>${postDate} by ${escapeHtml(item.author)} (表示終了: ${endDate})</span>
                  <button class="btn-danger" onclick="handleDeleteAnnouncement(${item.rowNum})">削除</button>
              </div>
          </div>
      `;
  }).join('');
}

/**
 * @summary 児童詳細モーダルの内容を描画する
 * @param {Object} data - 児童の詳細データ
 */
function renderStudentDetailModal(data) {
   const modalContent = document.getElementById('student-detail-content');
   const missionsHtml = data.missions.map(m => {
       const progressPercentage = m.target > 0 ? Math.min(100, (m.progress / m.target) * 100) : 0;
       let statusText = '';
       if (m.isClaimed) statusText = '<span class="text-xs font-bold text-gray-500">受取済</span>';
       else if (m.isComplete) statusText = '<span class="text-xs font-bold text-green-600">達成!</span>';
       else statusText = '<span class="text-xs text-gray-500">挑戦中</span>';

       return `
           <div class="border-b py-1">
               <div class="flex justify-between items-center">
                   <p class="text-sm">${escapeHtml(m.content)}</p>
                   ${statusText}
               </div>
               <div class="relative w-full h-4 mt-1">
                  <div class="absolute w-full h-full exp-bar-bg rounded-full"></div>
                  <div class="absolute h-full exp-bar-fill rounded-full" style="width: ${progressPercentage}%"></div>
                  <div class="absolute w-full h-full text-center text-xs text-black font-semibold leading-4">${m.progress} / ${m.target}</div>
               </div>
           </div>`;
   }).join('');

   const activityHtml = data.recentActivity.map(log => {
       const date = new Date(log.timestamp);
       const formattedDate = `${date.getMonth()+1}/${date.getDate()} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
       return `<li class="text-sm border-b py-1">${escapeHtml(log.message)}<span class="text-xs text-gray-500 float-right">${formattedDate}</span></li>`;
   }).join('');

   modalContent.innerHTML = `
       <button onclick="closeModal('student-detail-modal')" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
       <h2 class="text-2xl font-mplus text-blue-800 mb-4">${escapeHtml(data.profile.nickname)} さんの詳細</h2>
       <div class="grid grid-cols-3 gap-4 flex-grow overflow-y-auto pr-2">
           <div class="col-span-1">
               <h3 class="text-lg font-bold mb-2">ステータス</h3>
               <div class="space-y-1 text-lg">
                   <p><strong>レベル:</strong> ${data.profile.level}</p>
                   <p><strong>経験値:</strong> ${data.profile.exp}</p>
                   <p><strong>累計経験値:</strong> ${data.profile.totalExp}</p>
                   <p><strong>交換ポイント:</strong> ${data.profile.exchangePoints}</p>
               </div>
           </div>
           <div class="col-span-1">
               <h3 class="text-lg font-bold mb-2">ミッション状況</h3>
               <div class="space-y-1">${missionsHtml}</div>
           </div>
           <div class="col-span-1">
               <h3 class="text-lg font-bold mb-2">最近のきろく</h3>
               <ul class="space-y-1 list-none">${activityHtml}</ul>
           </div>
       </div>
   `;

   document.getElementById('student-detail-modal').classList.remove('hidden');
}

// =================================================================
// 4. イベントハンドラ (Event Handlers)
// =================================================================

/**
 * @summary 「全員を選択/解除」チェックボックスが変更された時の処理
 * @param {Event} event - イベントオブジェクト
 */
function toggleAllStudents(event) {
   const isChecked = event.target.checked;
   document.querySelectorAll('.student-checkbox').forEach(checkbox => {
       checkbox.checked = isChecked;
   });
}

/**
 * @summary 「詳細を見る」ボタンがクリックされた時の処理
 */
function handleViewStudentDetail() {
   const selectedEmail = document.getElementById('student-detail-select').value;
   if (!selectedEmail) {
       alert('児童を選択してください。');
       return;
   }
   showLoading();
   google.script.run
       .withSuccessHandler(result => {
           hideLoading();
           if (result.success) {
               renderStudentDetailModal(result.data);
           } else {
               alert('エラー: ' + result.message);
           }
       })
       .withFailureHandler(handleError)
       .getStudentDetails(selectedEmail);
}

/**
 * @summary 「投稿する」ボタンがクリックされた時の処理
 */
function handlePostAnnouncement() {
  const message = document.getElementById('announcement-message').value;
  const endDate = document.getElementById('display-until').value;

  if (!message.trim()) {
      alert('メッセージを入力してください。');
      return;
  }

  const data = {
      message: message,
      author: teacherName,
      endDate: endDate || null
  };

  showLoading();
  google.script.run
      .withSuccessHandler(result => {
          hideLoading();
          if (result.success) {
              document.getElementById('announcement-message').value = '';
              document.getElementById('display-until').value = '';
              renderAnnouncements(result.announcements);
              alert('お知らせを投稿しました。');
          } else {
              alert('エラー: ' + result.message);
          }
      })
      .withFailureHandler(handleError)
      .postAnnouncement(data);
}

/**
 * @summary 「配布する」ボタンがクリックされた時の処理
 */
function handleGrantPoint() {
   const checkedEmails = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
   const pointType = document.querySelector('input[name="point_type"]:checked').value;
   const amount = document.getElementById('point-amount').value;
   const reason = document.getElementById('grant-reason').value;

   if (checkedEmails.length === 0) {
       alert('児童を1人以上選択してください。');
       return;
   }
   if (!amount || !reason) {
       alert('配布量と理由を入力してください。');
       return;
   }
  
   const amountNum = parseInt(amount, 10);
   if (isNaN(amountNum) || amountNum <= 0) {
       alert('配布量には正の整数を入力してください。');
       return;
   }

   const data = {
       emails: checkedEmails,
       type: pointType,
       amount: amountNum,
       reason: reason
   };
  
   const pointTypeName = data.type === 'exp' ? '経験値' : '交換ポイント';

   if (!confirm(`${checkedEmails.length}人の児童に${pointTypeName}を${amountNum}配布します。\nよろしいですか？`)) {
       return;
   }

   showLoading();
   google.script.run
       .withSuccessHandler(result => {
           hideLoading();
           if (result.success) {
               alert(result.message);
               document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
               document.getElementById('select-all-students').checked = false;
               document.getElementById('point-amount').value = '';
               document.getElementById('grant-reason').value = '';
           } else {
               alert('エラー: ' + result.message);
           }
       })
       .withFailureHandler(handleError)
       .grantPoints(data);
}

/**
 * @summary お知らせの「削除」ボタンがクリックされた時の処理
 * @param {number} rowNum - 削除対象の行番号
 */
function handleDeleteAnnouncement(rowNum) {
  if (!confirm(rowNum + '行目のお知らせを削除しますか？')) return;

  showLoading();
  google.script.run
      .withSuccessHandler(result => {
          hideLoading();
          if (result.success) {
              renderAnnouncements(result.announcements);
          } else {
              alert('エラー: ' + result.message);
          }
      })
      .withFailureHandler(handleError)
      .deleteAnnouncement(rowNum);
}

// =================================================================
// 5. UIヘルパー関数 (UI Helpers)
// =================================================================

/**
 * @summary ローディング画面を表示する
 */
function showLoading() { document.getElementById('loading').classList.remove('hidden'); }

/**
 * @summary ローディング画面を非表示にする
 */
function hideLoading() { document.getElementById('loading').classList.add('hidden'); }

/**
 * @summary エラー発生時にメッセージを表示する
 * @param {Error} error - エラーオブジェクト
 */
function handleError(error) {
  hideLoading();
  alert('サーバーでエラーが発生しました: ' + error.message);
}

/**
 * @summary 指定されたモーダルを閉じる
 * @param {string} modalId - 閉じるモーダルのID
 */
function closeModal(modalId) {
   document.getElementById(modalId).classList.add('hidden');
}

/**
 * @summary 特殊文字をHTMLエンティティに変換する
 * @param {string} unsafe - サニタイズする文字列
 * @returns {string} サニタイズ済みの文字列
 */
function escapeHtml(unsafe) {
  if (unsafe === null || typeof unsafe === 'undefined') return '';
  return unsafe.toString().replace(/[&<>"']/g, match => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
  }[match]));
}
</script>
</body>
</html>

