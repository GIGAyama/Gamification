<script>
  // =================================================================
  // 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»çŠ¶æ…‹ç®¡ç† (Global State)
  // =================================================================

  /** @type {Object|null} ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸå…¨ã¦ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ */
  let gameData = null;

  /** @type {Object} ç¾åœ¨ç·¨é›†ä¸­ã®ã‚¢ãƒã‚¿ãƒ¼æ§‹æˆã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ */
  let currentAvatarComposition = {};

  /** @type {string|null} ãƒã‚¤ãƒ«ãƒ¼ãƒ ã§ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ†ã‚´ãƒªã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚µãƒªã‚¿ãƒ– */
  let currentActiveTab = null;

  /** @type {string} ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹æ•™å“¡ã®åå‰ */
  let teacherName = '';

  /** @type {Object[]} ã‚¯ãƒ©ã‚¹ã®å…¨å…ç«¥ã®ãƒªã‚¹ãƒˆ {number, nickname, email} */
  let studentsList = [];

  /** @type {Object} æ•™å“¡ç”»é¢ç”¨ï¼šèª­ã¿è¾¼ã‚“ã å…¨ä½“è¨­å®š */
  let appConfig = {};


  // =================================================================
  // 2. åˆæœŸåŒ–å‡¦ç† (Initialization)
  // =================================================================

  /**
  * @summary ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ¡ã‚¤ãƒ³ã®åˆæœŸåŒ–é–¢æ•°
  */
  document.addEventListener('DOMContentLoaded', initialize);

  /**
  * @summary ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æç”»ã‚’é–‹å§‹ã™ã‚‹
  * æ•™å“¡ã‹å…ç«¥ã‹ã‚’åˆ¤å®šã—ã€é©åˆ‡ãªUIã‚’è¡¨ç¤ºã™ã‚‹
  */
  function initialize() {
    showLoading();
    // ã¾ãšå…ç«¥ç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è©¦ã¿ã‚‹ï¼ˆå…ç«¥ãŒå¤§åŠã®ãŸã‚ï¼‰
    google.script.run
      .withSuccessHandler(response => {
        hideLoading();
        if (response && response.success) {
          // å…ç«¥ç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ -> å…ç«¥ç”¨UIè¡¨ç¤º
          setupStudentApp(response);
        } else {
          // å…ç«¥ç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—ï¼ˆæ¨©é™ã‚¨ãƒ©ãƒ¼ãªã©ï¼‰ -> æ•™å“¡ç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è©¦ã¿ã‚‹
          initializeTeacherDashboard();
        }
      })
      .withFailureHandler(error => {
        hideLoading();
        showError('ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
      })
      .getGameData();
  }

  /**
  * @summary å…ç«¥ç”¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸè¨­å®šã‚’è¡Œã†
  * @param {Object} response - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
  */
  function setupStudentApp(response) {
    gameData = response;
    currentAvatarComposition = { ...gameData.avatar };
    renderAll();
    document.getElementById('student-app').classList.remove('hidden');

    if (response.bonusApplied) {
      showModal(`<h3>ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ï¼</h3><p class="text-xl my-4">+ ${response.bonusPoints} <ruby>çµŒé¨“å€¤<rt>ã‘ã„ã‘ã‚“ã¡</rt></ruby>ã‚’<ruby>ç²å¾—<rt>ã‹ãã¨ã</rt></ruby>ï¼</p>`);
      showParticleEffect(response.bonusPoints); // â–¼ UIæ”¹å–„: ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    }
    if (response.newlyAwardedBadges && response.newlyAwardedBadges.length > 0) {
      showNewBadgeModal(response.newlyAwardedBadges);
    }
    if (response.latestLevelUp) {
      checkAndShowLevelUp(response.latestLevelUp);
    }
  }

  /**
   * @summary æ•™å“¡ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®åˆæœŸåŒ–ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—
   */
  function initializeTeacherDashboard() {
    showLoading();
    google.script.run
      .withSuccessHandler(data => {
        hideLoading();
        if (data && data.success) {
          // æ•™å“¡ç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ -> æ•™å“¡ç”¨UIè¡¨ç¤º
          document.getElementById('teacher-app').classList.remove('hidden');
          teacherName = data.teacherName;
          studentsList = data.students;
          appConfig = data.config || {};
          renderAnnouncementsList(data.announcements);
          populateStudentList(studentsList);
          populateStudentDetailSelect(studentsList);
          renderSettingsForm(appConfig);
          renderTeacherClassOverview(studentsList); // â–¼ æ–°è¦è¿½åŠ : ã‚¯ãƒ©ã‚¹çŠ¶æ³ã®æç”»
          setupTeacherEventListeners();
        } else {
          showError('ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚' + (data ? data.message : ''));
        }
      })
      .withFailureHandler(error => {
        hideLoading();
        showError('ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã‚¨ãƒ©ãƒ¼(æ•™å“¡): ' + error.message);
      })
      .getTeacherData();
  }


  // =================================================================
  // 3. UIãƒ¡ã‚¤ãƒ³æç”»é–¢æ•° (Main Rendering Functions)
  // =================================================================

  /**
  * @summary ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¨ã¦ã®UIè¦ç´ ã‚’æç”»ã™ã‚‹
  */
  function renderAll() {
    renderHeader();
    renderDashboard();
    setupEventListeners();
  }

  /**
  * @summary ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æç”»ã™ã‚‹
  */
  function renderHeader() {
    const p = gameData.profile;
    document.getElementById('user-profile-header').innerHTML = `
  <div class="font-mplus">${p.nickname} ã•ã‚“</div>
  <div>Lv. ${p.level} | <ruby>çµŒé¨“å€¤<rt>ã‘ã„ã‘ã‚“ã¡</rt></ruby>: ${p.exp} | <ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby>Pt: ${p.exchangePoints}</div>
`;
  }

  /**
  * @summary ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ï¼ˆå†’é™ºã®æ›¸ï¼‰ã®UIã‚’æç”»ã™ã‚‹
  */
  function renderDashboard() {
    const p = gameData.profile;
    document.getElementById('user-status').innerHTML = `
  <p><strong>ãƒ¬ãƒ™ãƒ«:</strong> ${p.level}</p>
  <p><strong><ruby>çµŒé¨“å€¤<rt>ã‘ã„ã‘ã‚“ã¡</rt></ruby>:</strong> ${p.exp}</p>
  <p><strong><ruby>ç´¯è¨ˆ<rt>ã‚‹ã„ã‘ã„</rt></ruby>:</strong> ${p.totalExp}</p>
  <div class="mt-2">
    <p class="text-sm">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§</p>
    <div class="w-full exp-bar-bg rounded-full h-4"><div class="exp-bar-fill h-4 rounded-full" style="width: ${p.progress || 0}%"></div></div>
  </div>
`;
    renderAvatarPreview('avatar-preview-main', gameData.avatar);

    let mvpHtml = '<h4 class="font-bold text-amber-600">ä»Šæ—¥ã®MVPï¼</h4>';
    if (gameData.rankings.mvp && gameData.rankings.mvp.length > 0) {
      mvpHtml += '<ol class="list-decimal list-inside text-sm">';
      gameData.rankings.mvp.forEach(r => { mvpHtml += `<li>${r.nickname} (+${r.gainedExp} EXP)</li>`; });
      mvpHtml += '</ol>';
    } else {
      mvpHtml += '<p class="text-sm text-fantasy-brown">ã¾ã ä»Šæ—¥ã®<ruby>å†’é™ºè€…<rt>ã¼ã†ã‘ã‚“ã—ã‚ƒ</rt></ruby>ã¯ã„ãªã„ã‚ˆã†ã§ã™ã€‚</p>';
    }

    let top5Html = `<h4 class="font-bold mt-3"><ruby>ç·åˆ<rt>ãã†ã”ã†</rt></ruby>ãƒ¬ãƒ™ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4><ol class="list-decimal list-inside text-sm">`;
    gameData.rankings.top5.forEach(r => {
      top5Html += `<li>${r.nickname} (Lv.${r.level})</li>`;
    });
    top5Html += '</ol>';
    document.getElementById('rankings-board').innerHTML = mvpHtml + top5Html;

    document.getElementById('missions-board').innerHTML = `
  <div id="daily-missions"></div>
  <div id="weekly-missions" class="mt-4"></div>
  <div id="coop-missions" class="mt-4"></div>
`;
    renderMissions();
    renderRecentActivity();
    renderAnnouncements();
  }

  /**
  * @summary ãƒã‚¤ãƒ«ãƒ¼ãƒ ç”»é¢ã®UIã‚’æç”»ã™ã‚‹
  */
  function renderMyRoom() {
    const myRoomContainer = document.getElementById('my-room');
    myRoomContainer.innerHTML = `
<div class="grid md:grid-cols-3 gap-6 h-full min-h-0">
  <!-- å·¦ã‚«ãƒ©ãƒ ï¼šã‚¢ãƒã‚¿ãƒ¼ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
  <div class="md:col-span-1 flex flex-col gap-4 h-full min-h-0">
      <div class="bg-fantasy-card p-4 rounded-lg shadow-lg flex flex-col flex-shrink-0">
          <h2 class="text-2xl font-semibold mb-2 text-center">ã‚¢ãƒã‚¿ãƒ¼<ruby>ç·¨é›†<rt>ã¸ã‚“ã—ã‚…ã†</rt></ruby></h2>
          <div id="avatar-preview-editor" class="relative w-full aspect-square bg-gray-200 rounded-md overflow-hidden mx-auto mb-2"></div>
      </div>
      
      <div class="bg-fantasy-card p-4 rounded-lg shadow-lg flex-1 flex flex-col min-h-0">
          <h2 class="text-2xl font-semibold mb-2 text-center flex-shrink-0">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
          <div class="space-y-2 flex-grow flex flex-col overflow-y-auto pr-1">
             <div class="flex flex-col">
                 <label for="profile-motto" class="block text-sm font-bold text-fantasy-brown">ã²ã¨ã“ã¨</label>
                 <textarea id="profile-motto" rows="2" class="w-full p-1 border border-fantasy-brown rounded-md"></textarea>
             </div>
             <div class="flex flex-col">
                 <label for="profile-favorite" class="block text-sm font-bold text-fantasy-brown">ã™ããªã‚‚ã®</label>
                 <textarea id="profile-favorite" rows="2" class="w-full p-1 border border-fantasy-brown rounded-md"></textarea>
             </div>
             <div class="flex flex-col">
                 <label for="profile-goal" class="block text-sm font-bold text-fantasy-brown">ãŒã‚“ã°ã‚ŠãŸã„ã“ã¨</label>
                 <textarea id="profile-goal" rows="2" class="w-full p-1 border border-fantasy-brown rounded-md"></textarea>
             </div>
          </div>
      </div>
  </div>

  <!-- å³ã‚«ãƒ©ãƒ ï¼šã‚¢ã‚¤ãƒ†ãƒ ã€ãƒãƒƒã‚¸ã€ãƒœã‚¿ãƒ³é¡ -->
  <div class="md:col-span-2 flex flex-col gap-4 h-full min-h-0">
      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ« -->
      <div class="bg-fantasy-card p-3 rounded-lg shadow-md flex justify-between items-center gap-4 flex-shrink-0 flex-wrap">
          <button id="save-avatar-button" class="btn-primary flex-1 py-2 text-sm md:text-base"><i class="fas fa-save mr-1"></i> ã‚¢ãƒã‚¿ãƒ¼ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’<ruby>ä¿å­˜<rt>ã»ãã‚“</rt></ruby></button>
          <button id="gacha-button" class="btn-gacha flex-1 py-2 text-sm md:text-base"></button>
          <button id="gacha-10-button" class="btn-gacha10 flex-1 py-2 text-sm md:text-base"></button>
          <!-- save-profile-button ã¯ã‚¢ãƒã‚¿ãƒ¼ä¿å­˜ã¨çµ±åˆã™ã‚‹ã‹ã€éè¡¨ç¤ºã«ã—ã¦ JS å´ã§ãƒãƒ³ãƒ‰ãƒ« -->
          <button id="save-profile-button" class="hidden"></button> 
      </div>

      <!-- ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ -->
      <div class="bg-fantasy-card p-4 rounded-lg shadow-lg flex-1 flex flex-col min-h-0">
          <h2 class="text-xl font-semibold mb-2 flex-shrink-0 border-b-2 border-fantasy-brown pb-1">ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãˆã‚‰ã¶</h2>
          <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»ã¯ã¿å‡ºã—å¯¾å¿œ -->
          <div id="category-tabs" class="border-b border-fantasy-brown mb-2 flex flex-nowrap overflow-x-auto shrink-0 pb-1 custom-scrollbar"></div>
          <div id="item-list" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 flex-grow overflow-y-auto p-1 pr-2 custom-scrollbar"></div>
      </div>

      <!-- ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="bg-fantasy-card p-4 rounded-lg shadow-lg h-48 flex flex-col flex-shrink-0">
          <h2 class="text-xl font-semibold mb-2 flex-shrink-0 border-b-2 border-fantasy-brown pb-1"><ruby>ç²å¾—<rt>ã‹ãã¨ã</rt></ruby>ã—ãŸãƒãƒƒã‚¸</h2>
          <div id="badge-collection" class="flex flex-wrap gap-2 overflow-y-auto p-1 custom-scrollbar"></div>
      </div>
  </div>
</div>
`;
    const userProfile = gameData.userProfile;
    document.getElementById('profile-motto').value = userProfile.motto;
    document.getElementById('profile-favorite').value = userProfile.favorite;
    document.getElementById('profile-goal').value = userProfile.goal;

    document.getElementById('save-avatar-button').addEventListener('click', handleSaveAvatar);
    document.getElementById('gacha-button').addEventListener('click', handleGacha);
    document.getElementById('gacha-10-button').addEventListener('click', handleGacha10);

    renderAvatarPreview('avatar-preview-editor', currentAvatarComposition);
    renderCategoryTabs();
    const firstTab = document.querySelector('#category-tabs button');
    if (firstTab) {
      handleCategoryClick(firstTab.dataset.tab);
    }

    document.getElementById('gacha-button').textContent = `ã‚¬ãƒãƒ£ (${gameData.gachaCost} EXP)`;
    document.getElementById('gacha-10-button').innerHTML = `10<ruby>é€£<rt>ã‚Œã‚“</rt></ruby>ã‚¬ãƒãƒ£ (${gameData.gacha10Cost} EXP)`;

    renderBadges();
  }

  /**
  * @summary ã¿ã‚“ãªã®åºƒå ´ç”»é¢ã®UIã‚’æç”»ã™ã‚‹
  */
  function renderPlaza() {
    const container = document.getElementById('plaza-container');
    if (!gameData.plazaData || gameData.plazaData.length === 0) {
      container.innerHTML = '<p>ã¾ã <ruby>èª°<rt>ã ã‚Œ</rt></ruby>ã‚‚ã„ãªã„ã‚ˆã†ã§ã™...</p>';
      return;
    }

    container.innerHTML = gameData.plazaData.map((user, index) => {
      const userJson = encodeURIComponent(JSON.stringify(user));
      // -3åº¦ã‹ã‚‰3åº¦ã®ãƒ©ãƒ³ãƒ€ãƒ ãªå‚¾ãã‚’ç”Ÿæˆ
      const randomRotation = Math.floor(Math.random() * 7) - 3;
      return `
<div class="quest-paper plaza-board-item p-4 text-center cursor-pointer transform transition-transform duration-200 hover:scale-105 hover:!rotate-0 hover:z-20 hover:shadow-xl group" 
     style="transform: rotate(${randomRotation}deg);"
     onclick='showPlazaProfileModal(JSON.parse(decodeURIComponent("${userJson}")))'
>
<div class="pin-tack group-hover:drop-shadow-md"></div>
<div id="plaza-avatar-${index}" class="relative w-full aspect-square bg-white rounded-sm overflow-hidden mb-3 border border-gray-300 group-hover:ring-2 ring-fantasy-brown"></div>
<p class="font-bold text-sm text-fantasy-deep font-mplus truncate">${escapeHtml(user.nickname)}</p>
<p class="text-xs text-fantasy-brown font-bold mt-1">Lv. ${user.level}</p>
</div>
`;
    }).join('');

    gameData.plazaData.forEach((user, index) => {
      renderAvatarPreview(`plaza-avatar-${index}`, user.avatar);
    });
  }

  // =================================================================
  // 4. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæç”»é–¢æ•° (Component Rendering Functions)
  // =================================================================

  /**
  * @summary ãŠçŸ¥ã‚‰ã›æ¬„ã‚’æç”»ã™ã‚‹
  */
  function renderAnnouncements() {
    const container = document.getElementById('announcements-board');
    if (!gameData.announcements || gameData.announcements.length === 0) {
      container.innerHTML = '<p class="text-sm text-fantasy-brown">ã„ã¾ã¯ã€ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }
    container.innerHTML = gameData.announcements.map(item => {
      const date = new Date(item.timestamp);
      const formattedDate = `${date.getMonth() + 1}/${date.getDate()}`;
      return `
<div class="border-b-2 border-dashed border-fantasy-brown pb-2 mb-2">
  <p class="text-base font-semibold text-fantasy-deep">${item.message}</p>
  <p class="text-xs text-right text-fantasy-brown mt-1">${formattedDate} by ${item.author}</p>
</div>
`;
    }).join('');
  }

  /**
  * @summary ã€Œæœ€è¿‘ã®è¨˜éŒ²ã€æ¬„ã‚’æç”»ã™ã‚‹
  */
  function renderRecentActivity() {
    const container = document.getElementById('recent-activity-log');
    if (!gameData.recentActivity || gameData.recentActivity.length === 0) {
      container.innerHTML = '<p class="text-sm text-fantasy-brown">ã¾ã <ruby>è¨˜éŒ²<rt>ãã‚ã</rt></ruby>ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }
    container.innerHTML = gameData.recentActivity.map(log => {
      const date = new Date(log.timestamp);
      const formattedDate = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
      return `
<div class="text-sm border-b border-fantasy-brown pb-1 mb-1">
  <p class="text-fantasy-deep">${log.message}</p>
  <p class="text-xs text-right text-fantasy-brown">${formattedDate}</p>
</div>
`;
    }).join('');
  }

  /**
  * @summary ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒœãƒ¼ãƒ‰ã‚’ç¨®é¡åˆ¥ã«æç”»ã™ã‚‹
  */
  function renderMissions() {
    const dailyContainer = document.getElementById('daily-missions');
    const weeklyContainer = document.getElementById('weekly-missions');
    const coopContainer = document.getElementById('coop-missions');

    const dailyMissions = gameData.missions.filter(m => m.type === 'ãƒ‡ã‚¤ãƒªãƒ¼');
    const weeklyMissions = gameData.missions.filter(m => m.type === 'ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼');
    const coopMissions = gameData.missions.filter(m => m.type === 'å”åŠ›');

    dailyContainer.innerHTML = '<h3>ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</h3>' + (dailyMissions.length > 0 ? dailyMissions.map(renderMissionCard).join('') : '<p class="text-sm text-fantasy-brown">ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>');
    weeklyContainer.innerHTML = `<h3><ruby>ä»Šé€±<rt>ã“ã‚“ã—ã‚…ã†</rt></ruby>ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</h3>` + (weeklyMissions.length > 0 ? weeklyMissions.map(renderMissionCard).join('') : `<p class="text-sm text-fantasy-brown"><ruby>ä»Šé€±<rt>ã“ã‚“ã—ã‚…ã†</rt></ruby>ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`);
    coopContainer.innerHTML = `<h3><ruby>å”åŠ›<rt>ãã‚‡ã†ã‚Šã‚‡ã</rt></ruby>ãƒŸãƒƒã‚·ãƒ§ãƒ³</h3>` + (coopMissions.length > 0 ? coopMissions.map(renderMissionCard).join('') : `<p class="text-sm text-fantasy-brown"><ruby>å”åŠ›<rt>ãã‚‡ã†ã‚Šã‚‡ã</rt></ruby>ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`);
  }

  /**
  * @summary ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰1æšã®HTMLã‚’ç”Ÿæˆã™ã‚‹
  */
  function renderMissionCard(mission) {
    let buttonHtml;
    if (mission.isClaimed) {
      buttonHtml = `<button class="btn-secondary btn-mission" disabled><ruby>å—å–æ¸ˆ<rt>ã†ã‘ã¨ã‚Šãšã¿</rt></ruby></button>`;
    } else if (mission.isComplete) {
      buttonHtml = `<button class="btn-claim btn-mission" onclick="handleClaimMission('${mission.id}')"><ruby>å—<rt>ã†</rt></ruby>ã‘<ruby>å–<rt>ã¨</rt></ruby>ã‚‹</button>`;
    } else {
      buttonHtml = `<button class="btn-secondary btn-mission" disabled><ruby>æŒ‘æˆ¦ä¸­<rt>ã¡ã‚‡ã†ã›ã‚“ã¡ã‚…ã†</rt></ruby></button>`;
    }

    const progressPercentage = mission.target > 0 ? Math.min(100, (mission.progress / mission.target) * 100) : 0;

    return `
<div class="border border-fantasy-brown rounded-lg p-2 bg-white mt-1">
<div class="flex justify-between items-start">
  <div class="mr-2 flex-grow">
    <p class="font-bold text-sm leading-tight">${mission.content}</p>
    <p class="text-xs text-fantasy-brown"><ruby>å ±é…¬<rt>ã»ã†ã—ã‚…ã†</rt></ruby>: ${mission.rewardType} +${mission.rewardAmount}</p>
  </div>
  <div class="flex-shrink-0">${buttonHtml}</div>
</div>
<div class="relative w-full h-4 mt-1.5">
  <div class="absolute w-full h-full exp-bar-bg rounded-full"></div>
  <div class="absolute h-full exp-bar-fill rounded-full" style="width: ${progressPercentage}%"></div>
  <div class="absolute w-full h-full text-center text-xs text-black font-semibold leading-4 flex items-center justify-center">
    <span>${mission.progress} / ${mission.target}</span>
  </div>
</div>
</div>
`;
  }

  /**
  * @summary ç²å¾—æ¸ˆã¿ãƒãƒƒã‚¸ä¸€è¦§
  */
  function renderBadges() {
    const container = document.getElementById('badge-collection');
    if (!container) return;
    if (!gameData.badges || gameData.badges.length === 0) {
      container.innerHTML = '<p class="text-center text-fantasy-brown">ã¾ã ãƒãƒƒã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }
    container.innerHTML = gameData.badges.map(badge => {
      const iconHtml = badge.imageUrl
        ? `<img src="${badge.imageUrl}" alt="${badge.name}" class="w-12 h-12 object-contain">`
        : '<span class="text-5xl">ğŸ†</span>';

      return `
<div class="tooltip bg-gray-200 p-2 rounded-lg aspect-square flex flex-col items-center justify-center text-center">
${iconHtml}
<span class="text-xs font-bold mt-1">${badge.name}</span>
<span class="tooltip-text">${badge.description}</span>
</div>
`;
    }).join('');
  }

  /**
  * @summary ã‚¢ãƒã‚¿ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”»
  */
  function renderAvatarPreview(elementId, composition) {
    const previewArea = document.getElementById(elementId);
    if (!previewArea) return;
    previewArea.innerHTML = '';
    const itemIds = Object.values(composition).filter(id => id !== null && String(id).trim() !== '');
    const items = itemIds.map(id => gameData.allItems.find(item => item['ã‚¢ã‚¤ãƒ†ãƒ ID'] == id)).filter(item => item);
    items.sort((a, b) => (a['ãƒ¬ã‚¤ãƒ¤ãƒ¼'] || 0) - (b['ãƒ¬ã‚¤ãƒ¤ãƒ¼'] || 0));

    if (items.length === 0) {
      previewArea.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400">ã‚¢ã‚¤ãƒ†ãƒ ã‚’<ruby>é¸<rt>ãˆã‚‰</rt></ruby>ã¼ã†</div>';
      return;
    }
    items.forEach(item => {
      if (item.imageUrl) {
        const img = document.createElement('img');
        img.src = item.imageUrl;
        img.className = 'absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 max-w-full max-h-full object-contain';
        img.style.zIndex = item['ãƒ¬ã‚¤ãƒ¤ãƒ¼'] || 0;
        previewArea.appendChild(img);
      }
    });
  }

  /**
  * @summary ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–æç”»
  */
  function renderCategoryTabs() {
    const tabsContainer = document.getElementById('category-tabs');
    if (!tabsContainer) return;

    const normalCategories = gameData.itemCategories.filter(c => c !== 'ã‚¢ã‚¯ã‚»ã‚µãƒª');
    const tabsToDisplay = [...normalCategories, 'ã‚¢ã‚¯ã‚»1', 'ã‚¢ã‚¯ã‚»2', 'ã‚¢ã‚¯ã‚»3'];

    tabsContainer.innerHTML = '';
    const nav = document.createElement('nav');
    nav.className = '-mb-px flex space-x-2 flex-wrap text-sm';

    tabsToDisplay.forEach(tabName => {
      const tab = document.createElement('button');
      tab.textContent = tabName;
      tab.dataset.tab = tabName;
      tab.className = 'whitespace-nowrap pb-2 px-1 border-b-2 font-medium border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors';
      tab.onclick = () => handleCategoryClick(tabName);
      nav.appendChild(tab);
    });
    tabsContainer.appendChild(nav);
  }

  /**
  * @summary æŒ‡å®šã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã®ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§æç”»
  */
  function renderItemList(displayCategory) {
    const listContainer = document.getElementById('item-list');
    if (!listContainer) return;
    listContainer.innerHTML = '';

    const filterCategory = ['ã‚¢ã‚¯ã‚»1', 'ã‚¢ã‚¯ã‚»2', 'ã‚¢ã‚¯ã‚»3'].includes(displayCategory) ? 'ã‚¢ã‚¯ã‚»ã‚µãƒª' : displayCategory;
    const filteredItems = gameData.allItems.filter(item => item['ã‚«ãƒ†ã‚´ãƒª'] === filterCategory);
    const equippedAccessoryIds = ['ã‚¢ã‚¯ã‚»1_ã‚¢ã‚¤ãƒ†ãƒ ID', 'ã‚¢ã‚¯ã‚»2_ã‚¢ã‚¤ãƒ†ãƒ ID', 'ã‚¢ã‚¯ã‚»3_ã‚¢ã‚¤ãƒ†ãƒ ID'].map(key => currentAvatarComposition[key]).filter(id => id);

    filteredItems.forEach(item => {
      const isInitialItem = String(item['å¿…è¦äº¤æ›ãƒã‚¤ãƒ³ãƒˆ']) === '0';
      const hasItem = gameData.inventory.includes(item['ã‚¢ã‚¤ãƒ†ãƒ ID']) || isInitialItem;

      let isEquipped = false;
      if (filterCategory === 'ã‚¢ã‚¯ã‚»ã‚µãƒª') {
        isEquipped = equippedAccessoryIds.includes(item['ã‚¢ã‚¤ãƒ†ãƒ ID']);
      } else {
        const categoryKey = `${filterCategory}_ã‚¢ã‚¤ãƒ†ãƒ ID`;
        isEquipped = currentAvatarComposition[categoryKey] === item['ã‚¢ã‚¤ãƒ†ãƒ ID'];
      }
      const exchangeCost = Number(item['å¿…è¦äº¤æ›ãƒã‚¤ãƒ³ãƒˆ'] || 0);

      const card = document.createElement('div');
      card.className = `group relative border rounded-lg p-2 cursor-pointer transition-all ${isEquipped ? 'border-blue-500 ring-2 ring-blue-500' : 'border-gray-200'} ${hasItem ? 'bg-white' : 'bg-gray-100'}`;
      card.onclick = () => handleItemClick(item);

      let overlay = '';
      if (!hasItem) {
        if (exchangeCost > 0) {
          overlay = `<div class="absolute inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center text-white p-1 rounded-lg"><span class="font-bold text-sm">${exchangeCost} Ptã§<ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby></span></div>`;
        } else if (item['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼']) {
          overlay = `<div class="absolute inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center text-white p-1 rounded-lg"><span class="font-semibold text-xs text-center">ã‚¬ãƒãƒ£ã§<ruby>å…¥æ‰‹<rt>ã«ã‚…ã†ã—ã‚…</rt></ruby></span></div>`;
        }
      }

      card.innerHTML = `
        <div class="aspect-square flex items-center justify-center">
            <img src="${item.imageUrl || ''}" alt="${item['ã‚¢ã‚¤ãƒ†ãƒ å']}" class="max-w-full max-h-full object-contain ${hasItem ? '' : 'opacity-50'}">
        </div>
        <p class="text-xs text-center mt-1 h-4 truncate group-hover:whitespace-normal group-hover:text-clip">${item['ã‚¢ã‚¤ãƒ†ãƒ å'] || ''}</p>
        ${overlay}
    `;
      listContainer.appendChild(card);
    });
  }

  // =================================================================
  // 5. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨ãƒãƒ³ãƒ‰ãƒ© (Event Listeners & Handlers)
  // =================================================================

  function setupEventListeners() {
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', e => {
        const btn = e.currentTarget;
        const viewName = btn.dataset.view;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewName).classList.add('active');

        if (viewName === 'my-room') renderMyRoom();
        else if (viewName === 'plaza') renderPlaza();
      });
    });
  }

  function handleClaimMission(missionId) {
    const cleanedMissionId = missionId.trim();
    showLoading();
    google.script.run
      .withSuccessHandler(res => {
        hideLoading();
        if (res.success) {
          gameData.profile.exp = res.newExp;
          gameData.profile.totalExp = res.newTotalExp;
          gameData.profile.exchangePoints = res.newExchangePoints;
          const mission = gameData.missions.find(m => m.id === cleanedMissionId);
          if (mission) mission.isClaimed = true;
          renderHeader();
          renderDashboard();

          // â–¼ UIæ”¹å–„: ã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã«åŠ ãˆã¦ã€ãƒªãƒƒãƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆå‘¼ã³å‡ºã—
          showRichEffect('ãƒŸãƒƒã‚·ãƒ§ãƒ³é”æˆï¼', null);
          showParticleEffect(50);
          showToast(res.message, 'success');
        } else {
          showError(res.message);
        }
      })
      .withFailureHandler(showError)
      .claimMissionReward(cleanedMissionId);
  }

  function handleCategoryClick(tabName) {
    currentActiveTab = tabName;
    document.querySelectorAll('#category-tabs button').forEach(button => {
      button.classList.toggle('border-blue-500', button.dataset.tab === tabName);
      button.classList.toggle('text-blue-600', button.dataset.tab === tabName);
    });
    renderItemList(tabName);
  }

  function handleItemClick(item) {
    const isInitialItem = String(item['å¿…è¦äº¤æ›ãƒã‚¤ãƒ³ãƒˆ']) === '0';
    const hasItem = gameData.inventory.includes(item['ã‚¢ã‚¤ãƒ†ãƒ ID']) || isInitialItem;

    if (hasItem) {
      if (item['ã‚«ãƒ†ã‚´ãƒª'] === 'ã‚¢ã‚¯ã‚»ã‚µãƒª') {
        const clickedItemId = item['ã‚¢ã‚¤ãƒ†ãƒ ID'];
        const accessorySlots = ['ã‚¢ã‚¯ã‚»1_ã‚¢ã‚¤ãƒ†ãƒ ID', 'ã‚¢ã‚¯ã‚»2_ã‚¢ã‚¤ãƒ†ãƒ ID', 'ã‚¢ã‚¯ã‚»3_ã‚¢ã‚¤ãƒ†ãƒ ID'];
        const activeSlotKey = `${currentActiveTab}_ã‚¢ã‚¤ãƒ†ãƒ ID`;

        const isDuplicate = accessorySlots.some(slotKey =>
          slotKey !== activeSlotKey && currentAvatarComposition[slotKey] === clickedItemId
        );
        if (isDuplicate) {
          showToast('ã“ã®ã‚¢ã‚¯ã‚»ã‚µãƒªã¯ã€ã™ã§ã«åˆ¥ã®ã°ã—ã‚‡ã«ã¤ã‘ã¦ã„ã¾ã™ã€‚', 'error'); // alert()ã‚’ç½®ãæ›ãˆ
          return;
        }
        if (currentAvatarComposition[activeSlotKey] === clickedItemId) {
          delete currentAvatarComposition[activeSlotKey];
        } else {
          currentAvatarComposition[activeSlotKey] = clickedItemId;
        }
      } else {
        const itemCategoryKey = `${item['ã‚«ãƒ†ã‚´ãƒª'].trim()}_ã‚¢ã‚¤ãƒ†ãƒ ID`;
        if (currentAvatarComposition[itemCategoryKey] === item['ã‚¢ã‚¤ãƒ†ãƒ ID']) {
          delete currentAvatarComposition[itemCategoryKey];
        } else {
          currentAvatarComposition[itemCategoryKey] = item['ã‚¢ã‚¤ãƒ†ãƒ ID'];
        }
      }
      renderAvatarPreview('avatar-preview-editor', currentAvatarComposition);
      renderItemList(currentActiveTab);

    } else if (Number(item['å¿…è¦äº¤æ›ãƒã‚¤ãƒ³ãƒˆ'] || 0) > 0) {
      // æ—¢å­˜ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ©ç”¨ãªã®ã§ãã®ã¾ã¾
      showModal(`
<h3>ã‚¢ã‚¤ãƒ†ãƒ <ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby></h3>
<p class="my-4">${item['ã‚¢ã‚¤ãƒ†ãƒ å']}ã‚’${item['å¿…è¦äº¤æ›ãƒã‚¤ãƒ³ãƒˆ']}<ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby>ãƒã‚¤ãƒ³ãƒˆã§<ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby>ã—ã¾ã™ã‹ï¼Ÿ</p>
<div class="flex justify-center gap-4">
  <button id="confirm-exchange" class="btn-primary"><ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby>ã™ã‚‹</button>
  <button id="cancel-exchange" class="btn-secondary">ã‚„ã‚ã‚‹</button>
</div>`, false);
      document.getElementById('confirm-exchange').onclick = () => { hideModal(); runExchangeItem(item['ã‚¢ã‚¤ãƒ†ãƒ ID']); };
      document.getElementById('cancel-exchange').onclick = hideModal;
    }
  }
  // â–¼ çµ±åˆä¿å­˜æ©Ÿèƒ½ (ã‚¢ãƒã‚¿ãƒ¼ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’åŒæ™‚ã«ä¿å­˜)
  function handleSaveAvatar() {
    showLoading();
    const profileData = {
      motto: document.getElementById('profile-motto').value,
      favorite: document.getElementById('profile-favorite').value,
      goal: document.getElementById('profile-goal').value,
    };

    google.script.run
      .withSuccessHandler(res => {
        // ç¶šã‘ã¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜
        google.script.run
          .withSuccessHandler(resProfile => {
            hideLoading();
            if (res.success && resProfile.success) {
              gameData.avatar = { ...currentAvatarComposition };
              gameData.userProfile = profileData;
              renderAvatarPreview('avatar-preview-main', gameData.avatar);
              showToast('ã‚¢ãƒã‚¿ãƒ¼ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            } else {
              showError(res.message || resProfile.message);
            }
          })
          .withFailureHandler(showError)
          .saveProfile(profileData);
      })
      .withFailureHandler(showError)
      .saveAvatar(currentAvatarComposition);
  }

  function handleGacha() {
    showModal(`
<h3>ã‚¬ãƒãƒ£</h3><p class="my-4">${gameData.gachaCost}<ruby>çµŒé¨“å€¤<rt>ã‘ã„ã‘ã‚“ã¡</rt></ruby>ã‚’<ruby>æ¶ˆè²»<rt>ã—ã‚‡ã†ã²</rt></ruby>ã—ã¦ã‚¬ãƒãƒ£ã‚’<ruby>å›<rt>ã¾ã‚</rt></ruby>ã—ã¾ã™ã‹ï¼Ÿ</p>
<div class="flex justify-center gap-4"> <button id="confirm" class="btn-gacha"><ruby>å›<rt>ã¾ã‚</rt></ruby>ã™</button> <button id="cancel" class="btn-secondary">ã‚„ã‚ã‚‹</button></div>`, false);
    document.getElementById('confirm').onclick = () => { hideModal(); runGacha('playGacha'); };
    document.getElementById('cancel').onclick = hideModal;
  }

  function handleGacha10() {
    showModal(`
<h3>10<ruby>é€£<rt>ã‚Œã‚“</rt></ruby>ã‚¬ãƒãƒ£</h3><p class="my-4">${gameData.gacha10Cost}<ruby>çµŒé¨“å€¤<rt>ã‘ã„ã‘ã‚“ã¡</rt></ruby>ã‚’<ruby>æ¶ˆè²»<rt>ã—ã‚‡ã†ã²</rt></ruby>ã—ã¦10<ruby>é€£<rt>ã‚Œã‚“</rt></ruby>ã‚¬ãƒãƒ£ã‚’<ruby>å›<rt>ã¾ã‚</rt></ruby>ã—ã¾ã™ã‹ï¼Ÿ</p>
<div class="flex justify-center gap-4"><button id="confirm" class="btn-gacha10"><ruby>å›<rt>ã¾ã‚</rt></ruby>ã™</button><button id="cancel" class="btn-secondary">ã‚„ã‚ã‚‹</button></div>`, false);
    document.getElementById('confirm').onclick = () => { hideModal(); runGacha('playGacha10'); };
    document.getElementById('cancel').onclick = hideModal;
  }

  // =================================================================
  // 6. ã‚µãƒ¼ãƒãƒ¼é€šä¿¡å®Ÿè¡Œé–¢æ•° (Server Call Executors)
  // =================================================================

  function runExchangeItem(itemId) {
    showLoading();
    google.script.run
      .withSuccessHandler(res => {
        hideLoading();
        if (res.success) {
          gameData.profile.exchangePoints = res.newExchangePoints;
          gameData.inventory.push(itemId);
          renderHeader();
          renderItemList(currentActiveTab);
          showToast(res.message, 'success'); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ãƒˆãƒ¼ã‚¹ãƒˆã¸
        } else {
          showError(res.message);
        }
      })
      .withFailureHandler(showError)
      .exchangeItem(itemId);
  }

  function runGacha(functionName) {
    showGachaLoading();
    google.script.run
      .withSuccessHandler(res => {
        hideGachaLoading();
        if (res.success) {
          gameData.profile.exp = res.newPoints;
          if (res.newExchangePoints !== undefined) gameData.profile.exchangePoints = res.newExchangePoints;

          if (functionName === 'playGacha10') {
            res.results.forEach(item => { if (!item.isDuplicate) gameData.inventory.push(item['ã‚¢ã‚¤ãƒ†ãƒ ID']); });

            // 10é€£ã®ä¸­ã«SRä»¥ä¸ŠãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const hasSR = res.results.some(item => item['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼'] === 'SR' || item['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼'] === 'SSR');
            if (hasSR) {
              const bestItem = res.results.find(item => item['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼'] === 'SR' || item['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼'] === 'SSR');
              showRichEffect('SUPER RARE!!', bestItem, () => showGacha10Result(res));
            } else {
              showGacha10Result(res);
            }
          } else {
            if (!res.isDuplicate) gameData.inventory.push(res.wonItem['ã‚¢ã‚¤ãƒ†ãƒ ID']);

            // å˜ç™ºã‚¬ãƒãƒ£ã§SRä»¥ä¸ŠãŒå‡ºãŸå ´åˆ
            if (!res.isDuplicate && (res.wonItem['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼'] === 'SR' || res.wonItem['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼'] === 'SSR')) {
              showRichEffect('SUPER RARE!!', res.wonItem, () => showGachaResult(res));
            } else {
              showGachaResult(res);
            }
          }
          renderHeader();
          if (currentActiveTab) renderItemList(currentActiveTab);
        } else {
          showError(res.message);
        }
      })
      .withFailureHandler(showError)
    [functionName]();
  }

  // =================================================================
  // 7. UIãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (UI Helpers)
  // =================================================================

  function showLoading() { document.getElementById('loading').classList.remove('hidden'); }
  function hideLoading() { document.getElementById('loading').classList.add('hidden'); }
  function hideModal() { document.getElementById('modal').classList.add('hidden'); }

  function showError(error) {
    hideLoading();
    hideGachaLoading();
    const message = error.message || JSON.stringify(error);
    console.error(message);
    showToast(message, 'error'); // alert/Errorãƒ¢ãƒ¼ãƒ€ãƒ«çµ±åˆ
  }

  function showModal(content, autoClose = true) {
    const modal = document.getElementById('modal');
    modal.classList.remove('hidden');
    document.getElementById('modal-content').innerHTML = `${content} <button id="modal-close" class="btn-secondary mt-4">ã¨ã˜ã‚‹</button>`;
    document.getElementById('modal-close').onclick = hideModal;
    if (autoClose) setTimeout(hideModal, 3000);
  }

  // â–¼ æ–°æ©Ÿèƒ½: ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥æ©Ÿèƒ½ (ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼)
  function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = `toast-msg ${type}`;
    toast.textContent = message;
    container.appendChild(toast);

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
    requestAnimationFrame(() => toast.classList.add('show'));

    // è‡ªå‹•æ¶ˆå»
    setTimeout(() => {
      toast.classList.remove('show');
      toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
  }

  // â–¼ æ–°æ©Ÿèƒ½: ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° (confirmç½®æ›ç”¨)
  function showConfirmDialog(message, onConfirmCallback) {
    const modal = document.getElementById('custom-confirm-modal');
    document.getElementById('custom-confirm-message').innerHTML = String(message).replace(/\n/g, '<br>');
    modal.classList.remove('hidden');

    const okBtn = document.getElementById('custom-confirm-ok');
    const cancelBtn = document.getElementById('custom-confirm-cancel');

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®é‡è¤‡ã‚’é˜²ããŸã‚ä¸€åº¦ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ç½®ãæ›ãˆã‚‹æ‰‹æ³•
    const newOkBtn = okBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);
    okBtn.parentNode.replaceChild(newOkBtn, okBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

    newOkBtn.onclick = () => {
      modal.classList.add('hidden');
      onConfirmCallback();
    };
    newCancelBtn.onclick = () => {
      modal.classList.add('hidden');
    };
  }

  // â–¼ æ–°æ©Ÿèƒ½: ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  function showParticleEffect(overrideAmount = 30) {
    const container = document.getElementById('confetti-container') || document.body;
    for (let i = 0; i < overrideAmount; i++) {
      const particle = document.createElement('div');
      particle.className = 'confetti-piece';
      const colors = ['#fde047', '#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#f43f5e'];
      particle.style.left = Math.random() * 100 + 'vw';
      particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      particle.style.animation = `confetti-fall ${Math.random() * 2 + 2}s linear forwards`; // infiniteå‰Šé™¤
      container.appendChild(particle);
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†æ™‚ã«è¦ç´ å‰Šé™¤
      setTimeout(() => particle.remove(), 4000);
    }
  }

  // â–¼ æ–°æ©Ÿèƒ½: ãƒªãƒƒãƒãƒ‡ã‚£ãƒ†ã‚£ãƒ¼ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®è¡¨ç¤ºåˆ¶å¾¡
  function showRichEffect(titleText, itemObj, onCompleteCallback = null) {
    const overlay = document.getElementById('rich-effect-overlay');
    const titleEl = document.getElementById('rich-effect-title');
    const itemEl = document.getElementById('rich-effect-item');

    // ãƒªã‚»ãƒƒãƒˆ
    overlay.classList.remove('hidden');
    overlay.classList.remove('rich-effect-active');
    titleEl.textContent = titleText;
    itemEl.innerHTML = '';

    if (itemObj && itemObj['ç”»åƒ']) {
      itemEl.innerHTML = `<img src="${itemObj['ç”»åƒ']}" class="w-64 h-64 object-contain drop-shadow-[0_0_20px_rgba(255,255,255,0.8)]">`;
    }

    // å†æç”»ã‚’å¼·åˆ¶ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
    void overlay.offsetWidth;
    overlay.classList.add('rich-effect-active');

    // åŠ¹æœéŸ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼åˆ¶ç´„ã«é…æ…®ã—ã¤ã¤å¯èƒ½ãªç¯„å›²ã§ï¼‰
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if (audioContext.state === 'running') {
      playFanfare(audioContext);
    }

    // è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
    setTimeout(() => {
      overlay.classList.add('hidden');
      overlay.classList.remove('rich-effect-active');
      if (onCompleteCallback) onCompleteCallback();
    }, 3500);
  }

  // ç°¡å˜ãªWeb Audio APIã«ã‚ˆã‚‹ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬
  function playFanfare(audioCtx) {
    const t = audioCtx.currentTime;
    const playTone = (freq, startTime, duration) => {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'square';
      osc.frequency.setValueAtTime(freq, startTime);
      gain.gain.setValueAtTime(0.1, startTime);
      gain.gain.linearRampToValueAtTime(0, startTime + duration);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start(startTime);
      osc.stop(startTime + duration);
    };

    // ã‚¿ã‚¿ã‚¿ã€ã‚¿ãƒ¼ãƒ³ï¼
    playTone(523.25, t, 0.15); // C5
    playTone(523.25, t + 0.15, 0.15);
    playTone(523.25, t + 0.3, 0.15);
    playTone(659.25, t + 0.45, 0.6); // E5
  }


  function showPlazaProfileModal(user) {
    const profile = user.profile;
    const safeMotto = escapeHtml(profile.motto || 'ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    const safeFavorite = escapeHtml(profile.favorite || 'ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    const safeGoal = escapeHtml(profile.goal || 'ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');

    const content = `
<div class="flex flex-col text-left">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼å¸¯ -->
  <div class="bg-blue-600 text-white -mt-6 -mx-6 px-4 sm:px-6 py-4 rounded-t-lg mb-4 shadow-md border-b-4 border-blue-800 flex justify-between items-center">
    <h3 class="text-xl sm:text-2xl font-mplus font-bold drop-shadow-md truncate pr-2">${escapeHtml(user.nickname)}</h3>
    <span class="text-lg font-bold bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full shadow-inner border-2 border-yellow-500 flex-shrink-0">Lv. ${user.level}</span>
  </div>

  <!-- 2ã‚«ãƒ©ãƒ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="flex flex-col sm:flex-row gap-4 px-2">
    <!-- å·¦ï¼šã‚¢ãƒã‚¿ãƒ¼ -->
    <div class="flex flex-col items-center flex-shrink-0 mx-auto sm:mx-0">
      <div class="bg-gradient-to-br from-gray-100 to-gray-300 p-2 rounded-xl shadow-inner border-2 border-gray-400">
        <div id="modal-avatar-preview" class="relative w-32 h-32 sm:w-40 sm:h-40 bg-white rounded-lg overflow-hidden border border-gray-200"></div>
      </div>
      <div class="mt-3 bg-fantasy-brown text-white text-sm font-bold px-4 py-1 rounded-full shadow">
        å†’é™ºè€…
      </div>
    </div>

    <!-- å³ï¼šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é …ç›® -->
    <div class="flex-grow space-y-3">
      <div class="bg-blue-50 p-3 rounded-lg border-2 border-blue-200 shadow-sm relative">
        <h4 class="text-sm font-bold text-blue-800 mb-1 flex items-center"><span class="mr-1">ğŸ’¬</span>ã²ã¨ã“ã¨</h4>
        <p class="text-gray-800 font-medium pl-1 leading-snug whitespace-pre-wrap">${safeMotto}</p>
      </div>
      
      <div class="bg-pink-50 p-3 rounded-lg border-2 border-pink-200 shadow-sm relative">
        <h4 class="text-sm font-bold text-pink-800 mb-1 flex items-center"><span class="mr-1">â¤ï¸</span>ã™ããªã‚‚ã®</h4>
        <p class="text-gray-800 font-medium pl-1 leading-snug whitespace-pre-wrap">${safeFavorite}</p>
      </div>

      <div class="bg-green-50 p-3 rounded-lg border-2 border-green-200 shadow-sm relative">
        <h4 class="text-sm font-bold text-green-800 mb-1 flex items-center"><span class="mr-1">â­</span>ãŒã‚“ã°ã‚ŠãŸã„ã“ã¨</h4>
        <p class="text-gray-800 font-medium pl-1 leading-snug whitespace-pre-wrap">${safeGoal}</p>
      </div>
    </div>
  </div>
</div>
`;
    showModal(content, false);
    renderAvatarPreview('modal-avatar-preview', user.avatar);
  }

  function showNewBadgeModal(badges) {
    const badgeHtml = badges.map(badge => `
<div class="border-2 border-yellow-400 rounded-lg p-4 my-2">
<p class="text-3xl">ğŸ†</p><p class="font-bold text-xl">${badge.name}</p>
<p class="text-sm text-fantasy-brown">${badge.description}</p>
</div>`).join('');
    showModal(`<h2 class="text-3xl text-yellow-500 animate-bounce"><ruby>å®Ÿç¸¾è§£é™¤<rt>ã˜ã£ã›ãã‹ã„ã˜ã‚‡</rt></ruby>ï¼</h2>${badgeHtml}`, false);
  }

  function showGachaResult(res) {
    const item = res.wonItem;
    let content;
    if (res.isDuplicate) {
      content = `<h3>ã‚¢ã‚¤ãƒ†ãƒ <ruby>é‡è¤‡<rt>ã˜ã‚…ã†ãµã</rt></ruby>ï¼</h3>
<p class="my-2">${item['ã‚¢ã‚¤ãƒ†ãƒ å']}</p><p class="text-lg font-bold text-green-500">+${res.awardedExchangePoints} <ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby>ãƒã‚¤ãƒ³ãƒˆ</p>`;
    } else {
      let rarityColor = res.wonItem['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼'] === 'SR' ? 'text-yellow-400' : (res.wonItem['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼'] === 'R' ? 'text-blue-500' : 'text-gray-500');
      content = `<h3 class="text-2xl font-bold mb-2 animate-bounce">GET!</h3>
<div class="p-4"><img src="${item['ç”»åƒ'] || ''}" class="mx-auto h-32 w-32 object-contain"></div>
<p class="text-lg font-bold">${item['ã‚¢ã‚¤ãƒ†ãƒ å']}</p><p class="font-bold text-xl ${rarityColor} ">ãƒ¬ã‚¢ãƒªãƒ†ã‚£: ${item['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼']}</p>`;
    }
    showModal(content, false);
  }

  function showGacha10Result(res) {
    let resultsHtml = res.results.map(item => {
      let rarityClass = item['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼'] === 'SR' ? 'is-sr' : (item['ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼'] === 'R' ? 'is-r' : '');
      let duplicateHtml = item.isDuplicate ? `<div class="duplicate-overlay"><span>+${item.awardedPoints} Pt</span></div>` : '';
      return `<div class="gacha-item-card ${rarityClass}"><img src="${item['ç”»åƒ'] || ''}" alt="${item['ã‚¢ã‚¤ãƒ†ãƒ å']}">${duplicateHtml}</div>`;
    }).join('');
    let summaryHtml = `<h3 class="text-xl font-bold mb-2">ã‚¬ãƒãƒ£<ruby>çµæœ<rt>ã‘ã£ã‹</rt></ruby></h3>
${res.summary.newItemsCount > 0 ? `<p class="text-lg"><ruby>æ–°<rt>ã‚ãŸã‚‰</rt></ruby>ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’<span class="font-bold text-blue-600"> ${res.summary.newItemsCount} <ruby>å€‹<rt>ã“</rt></ruby></span>GETï¼</p>` : ''}
${res.summary.awardedExchangePoints > 0 ? `<p class="text-lg"><span class="font-bold text-green-600">${res.summary.awardedExchangePoints} <ruby>äº¤æ›<rt>ã“ã†ã‹ã‚“</rt></ruby>ãƒã‚¤ãƒ³ãƒˆ</span>ã‚’<ruby>ç²å¾—<rt>ã‹ãã¨ã</rt></ruby>ï¼</p>` : ''}`;
    showModal(`${summaryHtml}<div class="gacha-results-grid my-4">${resultsHtml}</div>`, false);
  }

  function showGachaLoading() { document.getElementById('gacha-loading-modal').classList.remove('hidden'); }
  function hideGachaLoading() { document.getElementById('gacha-loading-modal').classList.add('hidden'); }

  function checkAndShowLevelUp(latestLevelUp) {
    const lastShownTimestamp = localStorage.getItem('lastShownLevelUpTimestamp');
    if (latestLevelUp.timestamp !== lastShownTimestamp) {
      showLevelUpModal(latestLevelUp.newLevel);
      localStorage.setItem('lastShownLevelUpTimestamp', latestLevelUp.timestamp);
    }
  }

  function showLevelUpModal(newLevel) {
    const modal = document.getElementById('level-up-modal');
    document.getElementById('level-up-text').textContent = `Lv. ${newLevel}`;
    modal.classList.remove('hidden');
    showParticleEffect(100); // æ–°æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦ç´™å¹é›ª

    setTimeout(() => {
      modal.classList.add('hidden');
      document.getElementById('confetti-container').innerHTML = '';
    }, 5000);
  }


  // =================================================================
  // 8. æ•™å“¡ç”¨UI/ã‚¤ãƒ™ãƒ³ãƒˆã®çµ±åˆ (Teacher Functionality)
  // =================================================================

  function setupTeacherEventListeners() {
    document.getElementById('post-announcement-btn').addEventListener('click', handlePostAnnouncement);
    document.getElementById('grant-point-btn').addEventListener('click', handleGrantPoint);
    document.getElementById('select-all-students').addEventListener('change', toggleAllStudents);
    document.getElementById('view-student-detail-btn').addEventListener('click', handleViewStudentDetail);
    document.getElementById('save-settings-btn').addEventListener('click', handleSaveSettings);
  }

  function populateStudentList(students) {
    const listEl = document.getElementById('student-list');
    listEl.innerHTML = '';
    if (!students || students.length === 0) {
      listEl.innerHTML = '<p class="text-gray-500">å…ç«¥ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
      return;
    }
    students.forEach((student, index) => {
      // UIæ”¹å–„: css.htmlã§æŒ‡å®šã—ãŸã‚¹ãƒˆãƒ©ã‚¤ãƒ—è£…é£¾ç”¨ã‚¯ãƒ©ã‚¹è¿½åŠ 
      const label = document.createElement('label');
      label.className = 'teacher-student-list-item flex items-center w-full p-2 cursor-pointer border-b last:border-0';
      label.innerHTML = `
       <input type="checkbox" class="student-checkbox mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500" value="${escapeHtml(student.email)}">
       <span class="font-medium text-gray-700">${escapeHtml(student.number)}ç•ª</span>
       <span class="ml-2 text-gray-900">${escapeHtml(student.nickname)}</span>
   `;
      listEl.appendChild(label);
    });
  }

  function populateStudentDetailSelect(students) {
    const selectEl = document.getElementById('student-detail-select');
    selectEl.innerHTML = '<option value="">-- å…ç«¥ã‚’é¸æŠ --</option>';
    if (!students || students.length === 0) return;
    students.forEach(student => {
      const option = document.createElement('option');
      option.value = student.email;
      option.textContent = `${student.number}ç•ª ${student.nickname}`;
      selectEl.appendChild(option);
    });
  }

  function renderAnnouncementsList(announcements) {
    const listEl = document.getElementById('announcements-list');
    if (!announcements || announcements.length === 0) {
      listEl.innerHTML = '<p class="text-gray-500">ç¾åœ¨è¡¨ç¤ºä¸­ã®ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }
    listEl.innerHTML = announcements.map((item) => {
      const postDate = new Date(item.timestamp).toLocaleDateString('ja-JP');
      const endDate = item.endDate ? new Date(item.endDate).toLocaleDateString('ja-JP') : 'ç„¡æœŸé™';
      return `
      <div class="bg-white p-3 rounded-md shadow-sm border mt-2">
          <p class="text-gray-800">${escapeHtml(item.message)}</p>
          <div class="text-xs text-gray-500 mt-2 flex justify-between items-center">
              <span>${postDate} by ${escapeHtml(item.author)} (è¡¨ç¤ºçµ‚äº†: ${endDate})</span>
              <button class="btn-danger" onclick="handleDeleteAnnouncement(${item.rowNum})">å‰Šé™¤</button>
          </div>
      </div>
  `;
    }).join('');
  }

  function renderStudentDetailModal(data) {
    const modalContent = document.getElementById('student-detail-content');
    const missionsHtml = data.missions.map(m => {
      const progressPercentage = m.target > 0 ? Math.min(100, (m.progress / m.target) * 100) : 0;
      let statusText = '';
      if (m.isClaimed) statusText = '<span class="text-xs font-bold text-gray-500">å—å–æ¸ˆ</span>';
      else if (m.isComplete) statusText = '<span class="text-xs font-bold text-green-600">é”æˆ!</span>';
      else statusText = '<span class="text-xs text-gray-500">æŒ‘æˆ¦ä¸­</span>';

      return `
       <div class="border-b py-1">
           <div class="flex justify-between items-center">
               <p class="text-sm">${escapeHtml(m.content)}</p>
               ${statusText}
           </div>
           <div class="relative w-full h-4 mt-1">
              <div class="absolute w-full h-full exp-bar-bg rounded-full"></div>
              <div class="absolute h-full exp-bar-fill rounded-full" style="width: ${progressPercentage}%"></div>
              <div class="absolute w-full h-full text-center text-xs text-gray-800 font-semibold leading-4">${m.progress} / ${m.target}</div>
           </div>
       </div>`;
    }).join('');

    const activityHtml = data.recentActivity.map(log => {
      const date = new Date(log.timestamp);
      const formattedDate = `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
      return `<li class="text-sm border-b py-1">${escapeHtml(log.message)}<span class="text-xs text-gray-500 float-right">${formattedDate}</span></li>`;
    }).join('');

    modalContent.innerHTML = `
   <button onclick="document.getElementById('student-detail-modal').classList.add('hidden')" class="absolute top-2 right-2 text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
   <h2 class="text-2xl font-mplus text-blue-800 mb-4">${escapeHtml(data.profile.nickname)} ã•ã‚“ã®è©³ç´°</h2>
   <div class="grid grid-cols-3 gap-4 flex-grow overflow-y-auto pr-2">
       <div class="col-span-1 border-r pr-2 shadow-sm">
           <h3 class="text-lg font-bold mb-2 bg-gray-100 p-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
           <div class="space-y-1 text-base p-2">
               <p><strong>ãƒ¬ãƒ™ãƒ«:</strong> ${data.profile.level}</p>
               <p><strong>çµŒé¨“å€¤:</strong> ${data.profile.exp}</p>
               <p><strong>ç´¯è¨ˆçµŒé¨“å€¤:</strong> ${data.profile.totalExp}</p>
               <p><strong>äº¤æ›ãƒã‚¤ãƒ³ãƒˆ:</strong> ${data.profile.exchangePoints}</p>
           </div>
       </div>
       <div class="col-span-1 px-2 border-r shadow-sm">
           <h3 class="text-lg font-bold mb-2 bg-gray-100 p-1">ãƒŸãƒƒã‚·ãƒ§ãƒ³çŠ¶æ³</h3>
           <div class="space-y-1">${missionsHtml}</div>
       </div>
       <div class="col-span-1 pl-2 shadow-sm">
           <h3 class="text-lg font-bold mb-2 bg-gray-100 p-1">æœ€è¿‘ã®ãã‚ã</h3>
           <ul class="space-y-1 list-none">${activityHtml}</ul>
       </div>
   </div>
`;
    document.getElementById('student-detail-modal').classList.remove('hidden');
  }

  // â–¼ æ–°è¦è¿½åŠ : æ•™å“¡ç”¨ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
  function switchTeacherTab(tabId) {
    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.teacher-tab-content').forEach(el => {
      el.classList.add('hidden');
    });
    document.getElementById('teacher-tab-' + tabId).classList.remove('hidden');

    // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.teacher-tab-btn').forEach(btn => {
      btn.classList.remove('bg-white', 'text-blue-800', 'border-blue-500', 'border-l', 'border-r', 'active-tab');
      btn.classList.add('bg-gray-200', 'text-gray-600', 'border-transparent', 'inactive-tab');
    });

    const activeBtn = document.getElementById('tab-' + tabId + '-btn');
    if (activeBtn) {
      activeBtn.classList.remove('bg-gray-200', 'text-gray-600', 'border-transparent', 'inactive-tab');
      activeBtn.classList.add('bg-white', 'text-blue-800', 'border-blue-500', 'border-l', 'border-r', 'active-tab');
    }
  }

  // â–¼ æ–°è¦è¿½åŠ : ã‚¯ãƒ©ã‚¹çŠ¶æ³ãƒœãƒ¼ãƒ‰ï¼ˆè¡¨å½¢å¼ï¼‰ã®æç”»
  function renderTeacherClassOverview(students) {
    const tbody = document.getElementById('teacher-class-overview-table');
    tbody.innerHTML = '';

    if (!students || students.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="py-4 text-center text-gray-500">å…ç«¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
      return;
    }

    students.forEach((student, index) => {
      // ã‚¹ãƒˆãƒ©ã‚¤ãƒ—èƒŒæ™¯è‰²
      const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
      const tr = document.createElement('tr');
      tr.className = `${rowClass} hover:bg-blue-50 transition-colors`;

      tr.innerHTML = `
        <td class="py-3 px-4 border-b text-center font-medium">${escapeHtml(String(student.number))}</td>
        <td class="py-3 px-4 border-b font-bold text-gray-800">${escapeHtml(student.nickname)}</td>
        <td class="py-3 px-4 border-b text-right font-bold text-blue-600">Lv.${escapeHtml(String(student.level || 1))}</td>
        <td class="py-3 px-4 border-b text-right text-gray-600">${escapeHtml(String(student.totalExp || 0))} Pt</td>
        <td class="py-3 px-4 border-b text-right text-green-600">${escapeHtml(String(student.exchangePoints || 0))} Pt</td>
        <td class="py-3 px-4 border-b text-center text-sm text-gray-500">${escapeHtml(String(student.lastLogin || '-'))}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function toggleAllStudents(event) {
    const isChecked = event.target.checked;
    document.querySelectorAll('.student-checkbox').forEach(checkbox => {
      checkbox.checked = isChecked;
    });
  }

  function handleViewStudentDetail() {
    const selectedEmail = document.getElementById('student-detail-select').value;
    if (!selectedEmail) {
      showToast('å…ç«¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error'); // alert()ç½®ãæ›ãˆ
      return;
    }
    showLoading();
    google.script.run
      .withSuccessHandler(result => {
        hideLoading();
        if (result.success) renderStudentDetailModal(result.data);
        else showToast('ã‚¨ãƒ©ãƒ¼: ' + result.message, 'error');
      })
      .withFailureHandler(error => {
        hideLoading();
        showToast('ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      })
      .getStudentDetails(selectedEmail);
  }

  function handlePostAnnouncement() {
    const message = document.getElementById('announcement-message').value;
    const endDate = document.getElementById('display-until').value;

    if (!message.trim()) {
      showToast('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error'); // alertç½®ãæ›ãˆ
      return;
    }
    const data = { message: message, author: teacherName, endDate: endDate || null };
    showLoading();
    google.script.run
      .withSuccessHandler(result => {
        hideLoading();
        if (result.success) {
          document.getElementById('announcement-message').value = '';
          document.getElementById('display-until').value = '';
          renderAnnouncementsList(result.announcements);
          showToast('ãŠçŸ¥ã‚‰ã›ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚', 'success'); // alertç½®ãæ›ãˆ
        } else {
          showToast('ã‚¨ãƒ©ãƒ¼: ' + result.message, 'error');
        }
      })
      .withFailureHandler(error => { hideLoading(); showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error'); })
      .postAnnouncement(data);
  }

  function handleGrantPoint() {
    const checkedEmails = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
    const pointType = document.querySelector('input[name="point_type"]:checked').value;
    const amount = document.getElementById('point-amount').value;
    const reason = document.getElementById('grant-reason').value;

    if (checkedEmails.length === 0) {
      showToast('å…ç«¥ã‚’1äººä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚', 'error'); return;
    }
    if (!amount || !reason) {
      showToast('é…å¸ƒé‡ã¨ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error'); return;
    }
    const amountNum = parseInt(amount, 10);
    if (isNaN(amountNum) || amountNum <= 0) {
      showToast('é…å¸ƒé‡ã«ã¯æ­£ã®æ•´æ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚', 'error'); return;
    }

    const pointTypeName = pointType === 'exp' ? 'çµŒé¨“å€¤' : 'äº¤æ›ãƒã‚¤ãƒ³ãƒˆ';
    const confirmMessage = `${checkedEmails.length}äººã®å…ç«¥ã«\nã€Œ${pointTypeName}ã€ã‚’ ${amountNum}Pt é…å¸ƒã—ã¾ã™ã€‚\n\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;

    // confirm() ã‚’ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« ã«ç½®ãæ›ãˆ
    showConfirmDialog(confirmMessage, () => {
      // === å®Ÿè¡Œç¢ºå®šå¾Œã®å‡¦ç† ===
      const data = { emails: checkedEmails, type: pointType, amount: amountNum, reason: reason };
      showLoading();
      google.script.run
        .withSuccessHandler(result => {
          hideLoading();
          if (result.success) {
            showToast(result.message, 'success'); // alertç½®ãæ›ãˆ
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('select-all-students').checked = false;
            document.getElementById('point-amount').value = '';
            document.getElementById('grant-reason').value = '';
          } else {
            showToast('ã‚¨ãƒ©ãƒ¼: ' + result.message, 'error');
          }
        })
        .withFailureHandler(error => { hideLoading(); showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error'); })
        .grantPoints(data);
    });
  }

  function handleDeleteAnnouncement(rowNum) {
    showConfirmDialog('ã“ã®ãŠçŸ¥ã‚‰ã›ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', () => {
      showLoading();
      google.script.run
        .withSuccessHandler(result => {
          hideLoading();
          if (result.success) {
            renderAnnouncementsList(result.announcements);
            showToast('ãŠçŸ¥ã‚‰ã›ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success'); // è¿½åŠ 
          } else {
            showToast('ã‚¨ãƒ©ãƒ¼: ' + result.message, 'error');
          }
        })
        .withFailureHandler(error => { hideLoading(); showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error'); })
        .deleteAnnouncement(rowNum);
    });
  }

  // =================================================================
  // ã‚¢ãƒ—ãƒªè¨­å®šï¼ˆã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼‰ç®¡ç†
  // =================================================================

  function renderSettingsForm(configData) {
    const container = document.getElementById('teacher-settings-form');
    container.innerHTML = '';

    if (!configData || Object.keys(configData).length === 0) {
      container.innerHTML = '<p class="text-sm text-gray-500">è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    let html = '';
    for (const key in configData) {
      const value = configData[key];
      const htmlId = 'config-input-' + encodeURIComponent(key);
      const isNumber = !isNaN(value) && value !== '';
      const inputType = isNumber ? 'number' : 'text';

      html += `
        <div class="mb-3">
          <label for="${htmlId}" class="block text-sm font-bold text-gray-700 mb-1">${escapeHtml(key)}</label>
          <input type="${inputType}" id="${htmlId}" data-config-key="${escapeHtml(key)}" value="${escapeHtml(String(value))}" class="w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-purple-200">
        </div>
      `;
    }
    container.innerHTML = html;
  }

  function handleSaveSettings() {
    const container = document.getElementById('teacher-settings-form');
    const inputs = container.querySelectorAll('input[data-config-key]');
    const newConfig = {};

    inputs.forEach(input => {
      const key = input.getAttribute('data-config-key');
      const val = input.value;
      newConfig[key] = input.type === 'number' ? Number(val) : val;
    });

    showConfirmDialog('è¨­å®šã‚’ä¿å­˜ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\\nâ€»å…¨å…ç«¥ã«å³æ™‚å½±éŸ¿ã—ã¾ã™ã€‚', () => {
      showLoading();
      google.script.run
        .withSuccessHandler(result => {
          hideLoading();
          if (result.success) {
            appConfig = newConfig; // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’æ›´æ–°
            showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚', 'success');
          } else {
            showToast('ã‚¨ãƒ©ãƒ¼: ' + result.message, 'error');
          }
        })
        .withFailureHandler(error => { hideLoading(); showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error'); })
        .updateConfigSettings(newConfig);
    });
  }

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: XSSå¯¾ç­–
  function escapeHtml(str) {
    if (typeof str !== 'string') return str;
    return str.replace(/[&'`"<>]/g, function (match) {
      return {
        '&': '&amp;',
        "'": '&#x27;',
        '`': '&#x60;',
        '"': '&quot;',
        '<': '&lt;',
        '>': '&gt;',
      }[match]
    });
  }
</script>